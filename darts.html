<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DartsOS: Ultimate Coach</title>
    <style>
        :root {
            --bg: #121212;
            --panel: #1e1e1e;
            --primary: #00e676; /* Green */
            --secondary: #2979ff; /* Blue */
            --danger: #ff1744; /* Red */
            --text-main: #ffffff;
            --text-dim: #b0bec5;
            --highlight: #ffd700;
        }

        body {
            background: var(--bg);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* --- LAYOUTS --- */
        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
            animation: fadeIn 0.3s ease;
        }
        .screen.active { display: flex; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        header {
            padding: 15px;
            background: var(--panel);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }
        
        h1 { margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }

        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 10px;
            overflow-y: auto;
        }

        /* --- MENU --- */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 800px;
            margin-top: 40px;
        }

        .menu-card {
            background: var(--panel);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }
        .menu-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .menu-icon { font-size: 3rem; margin-bottom: 15px; display: block; }
        .menu-title { font-weight: bold; font-size: 1.2rem; display: block; }
        .menu-desc { font-size: 0.8rem; color: var(--text-dim); margin-top: 5px; display: block; }

        /* --- BOARD --- */
        #board-container {
            width: 100%;
            max-width: 450px; 
            aspect-ratio: 1/1;
            position: relative;
            margin: 10px 0;
            flex-shrink: 0; 
        }
        
        svg { width: 100%; height: 100%; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); cursor: pointer; touch-action: manipulation; }
        
        .shot-marker {
            pointer-events: none;
            fill: var(--highlight);
            opacity: 0.8;
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* --- HUD --- */
        .hud-panel {
            width: 100%;
            max-width: 600px;
            background: var(--panel);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hud-score { font-size: 3rem; font-weight: bold; color: var(--primary); font-variant-numeric: tabular-nums; }
        .hud-label { font-size: 0.8rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
        
        .checkout-hint {
            background: #333;
            color: var(--highlight);
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.9rem;
            display: none; 
            margin-bottom: 10px;
        }

        /* --- CONTROLS --- */
        .controls { display: flex; gap: 10px; width: 100%; max-width: 450px; padding-bottom: 20px; }
        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            background: #333;
            color: white;
            transition: opacity 0.2s;
        }
        .btn:active { opacity: 0.7; }
        .btn-primary { background: var(--primary); color: black; }
        .btn-miss { background: #424242; color: #ff5252; border: 1px solid #ff5252; flex: 0.5; }

        /* --- CRICKET SCOREBOARD --- */
        .cricket-board { display: flex; width: 100%; max-width: 450px; justify-content: space-between; margin-bottom: 10px; }
        .cricket-col { display: flex; flex-direction: column; gap: 5px; align-items: center; }
        .cricket-num { 
            width: 40px; height: 30px; 
            display: flex; align-items: center; justify-content: center;
            background: #222; border-radius: 4px; font-weight: bold;
        }
        .cricket-mark { color: var(--primary); border: 1px solid var(--primary); background: rgba(0,230,118,0.1); }
        
    </style>
</head>
<body>

    <div id="screen-menu" class="screen active">
        <header>
            <h1>üéØ DartsOS <span style="font-size:0.6em; background:var(--primary); color:#000; padding:2px 6px; border-radius:4px;">PRO</span></h1>
        </header>
        <div class="main-area" style="justify-content: center;">
            <div style="text-align:center; margin-bottom: 20px;">
                <h2>Welcome, Player.</h2>
                <p style="color:var(--text-dim)">Select your training module.</p>
            </div>
            
            <div class="menu-grid">
                <div class="menu-card" onclick="app.loadMode('career')">
                    <span class="menu-icon">üéì</span>
                    <span class="menu-title">Coach Mode</span>
                    <span class="menu-desc">Zero to Hero Curriculum</span>
                </div>
                <div class="menu-card" onclick="app.loadMode('x01')">
                    <span class="menu-icon">üèÜ</span>
                    <span class="menu-title">X01 Game</span>
                    <span class="menu-desc">501 Scoring & Checkout</span>
                </div>
                <div class="menu-card" onclick="app.loadMode('cricket')">
                    <span class="menu-icon">ü¶ó</span>
                    <span class="menu-title">Cricket</span>
                    <span class="menu-desc">Strategy & Closing</span>
                </div>
                <div class="menu-card" onclick="app.loadMode('practice')">
                    <span class="menu-icon">üî•</span>
                    <span class="menu-title">Free Practice</span>
                    <span class="menu-desc">Heatmap & Grouping</span>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <header>
            <h1 id="game-title">Game Title</h1>
            <button class="btn" style="width: auto; padding: 5px 15px; font-size: 0.8rem;" onclick="app.goHome()">Exit</button>
        </header>

        <div class="main-area">
            
            <div class="hud-panel">
                <div>
                    <div class="hud-label" id="hud-label-1">Score</div>
                    <div class="hud-score" id="hud-val-1">501</div>
                </div>
                <div style="text-align: right;">
                    <div class="hud-label" id="hud-label-2">Round</div>
                    <div class="hud-score" id="hud-val-2" style="font-size: 1.5rem; color: white;">1</div>
                </div>
            </div>

            <div id="checkout-box" class="checkout-hint">Checkout: T20 T20 D12</div>

            <div id="cricket-ui" class="cricket-board" style="display:none;"></div>

            <div id="board-container"></div>

            <div style="text-align: center; color: var(--text-dim); font-size: 0.9rem; margin-top: 10px; font-style: italic; height: 20px;" id="status-msg">
                Tap the board to register hits
            </div>

            <div class="controls" style="margin-top: auto;">
                <button class="btn" onclick="app.undo()">Undo</button>
                <button class="btn btn-miss" onclick="app.handleHit(0, 'MISS', null)">Miss</button>
                <button class="btn btn-primary" id="btn-action" onclick="app.handleAction()">Next Round</button>
            </div>
        </div>
    </div>

<script>
/**
 * DartsOS Engine v2.1
 * Improvements: Fixed Icon Encodings, Added Miss Button
 */

const Speaker = {
    synth: window.speechSynthesis,
    speak: function(text) {
        if (!this.synth) return;
        this.synth.cancel(); 
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 1.1;
        this.synth.speak(u);
    }
};

const CHECKOUTS = {
    170: "Treble 20, Treble 20, Bullseye", 167: "Treble 20, Treble 19, Bullseye", 164: "Treble 20, Treble 18, Bullseye",
    161: "Treble 20, Treble 17, Bullseye", 160: "Treble 20, Treble 20, Double 20", 158: "Treble 20, Treble 20, Double 19",
    156: "Treble 20, Treble 20, Double 18", 150: "Treble 20, Treble 18, Double 18", 140: "Treble 20, Treble 16, Double 16",
    130: "Treble 20, Treble 18, Double 8", 120: "Treble 20, 20, Double 20", 110: "Treble 20, 10, Double 20",
    100: "Treble 20, Double 20", 60: "20, Double 20", 40: "Double 20", 32: "Double 16", 16: "Double 8", 8: "Double 4", 4: "Double 2"
};

const BoardRenderer = {
    render: function(containerId, clickCallback) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        const SVG_NS = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(SVG_NS, "svg");
        svg.setAttribute("viewBox", "0 0 450 450");
        svg.id = "dartboard-svg";

        const C = 225; 
        const sectors = [20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5];
        
        function drawArc(rIn, rOut, startIdx, type, color1, color2) {
            const angle = 360 / 20;
            sectors.forEach((score, i) => {
                const aStart = (i * angle) - (angle/2);
                const aEnd = aStart + angle;
                const radStart = (aStart - 90) * (Math.PI/180);
                const radEnd = (aEnd - 90) * (Math.PI/180);
                
                const x1 = C + rIn * Math.cos(radStart); const y1 = C + rIn * Math.sin(radStart);
                const x2 = C + rOut * Math.cos(radStart); const y2 = C + rOut * Math.sin(radStart);
                const x3 = C + rOut * Math.cos(radEnd); const y3 = C + rOut * Math.sin(radEnd);
                const x4 = C + rIn * Math.cos(radEnd); const y4 = C + rIn * Math.sin(radEnd);
                
                const d = `M${x1},${y1} L${x2},${y2} A${rOut},${rOut} 0 0,1 ${x3},${y3} L${x4},${y4} A${rIn},${rIn} 0 0,0 ${x1},${y1} Z`;
                
                const path = document.createElementNS(SVG_NS, "path");
                path.setAttribute("d", d);
                path.setAttribute("fill", (i%2===0) ? color1 : color2);
                path.onclick = (e) => clickCallback(score, type, e);
                svg.appendChild(path);
            });
        }

        drawArc(162, 170, 0, 'D', '#e53935', '#43a047'); 
        drawArc(107, 162, 0, 'S', '#121212', '#eeeeee'); 
        drawArc(99, 107, 0, 'T', '#e53935', '#43a047');  
        drawArc(16, 99, 0, 'S', '#121212', '#eeeeee');   
        
        const bullOut = document.createElementNS(SVG_NS, "circle");
        bullOut.setAttribute("cx", C); bullOut.setAttribute("cy", C); bullOut.setAttribute("r", 16); bullOut.setAttribute("fill", "#43a047");
        bullOut.onclick = (e) => clickCallback(25, 'S', e);
        svg.appendChild(bullOut);

        const bullIn = document.createElementNS(SVG_NS, "circle");
        bullIn.setAttribute("cx", C); bullIn.setAttribute("cy", C); bullIn.setAttribute("r", 6); bullIn.setAttribute("fill", "#e53935");
        bullIn.onclick = (e) => clickCallback(50, 'D', e);
        svg.appendChild(bullIn);

        sectors.forEach((s, i) => {
            const rad = ((i * 18) - 90) * (Math.PI/180);
            const x = C + 195 * Math.cos(rad);
            const y = C + 195 * Math.sin(rad);
            const txt = document.createElementNS(SVG_NS, "text");
            txt.setAttribute("x", x); txt.setAttribute("y", y);
            txt.setAttribute("text-anchor", "middle");
            txt.setAttribute("dominant-baseline", "middle");
            txt.setAttribute("fill", "white");
            txt.setAttribute("font-size", "20");
            txt.setAttribute("pointer-events", "none");
            txt.textContent = s;
            svg.appendChild(txt);
        });

        container.appendChild(svg);
    },

    addHeatmapDot: function(x, y) {
        const svg = document.getElementById("dartboard-svg");
        if(!svg) return;
        const pt = svg.createSVGPoint();
        pt.x = x; pt.y = y;
        const svgP = pt.matrixTransform(svg.getScreenCTM().inverse());

        const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        dot.setAttribute("cx", svgP.x);
        dot.setAttribute("cy", svgP.y);
        dot.setAttribute("r", 4);
        dot.setAttribute("class", "shot-marker");
        svg.appendChild(dot);
    }
};

const app = {
    mode: null, 
    state: {},
    historyStack: [], 

    goHome: function() {
        document.getElementById('screen-game').classList.remove('active');
        document.getElementById('screen-menu').classList.add('active');
    },

    loadMode: function(mode) {
        this.mode = mode;
        this.resetState();
        
        document.getElementById('screen-menu').classList.remove('active');
        document.getElementById('screen-game').classList.add('active');
        
        document.getElementById('cricket-ui').style.display = 'none';
        document.getElementById('checkout-box').style.display = 'none';
        
        BoardRenderer.render('board-container', this.handleHit.bind(this));
        
        if(mode === 'x01') {
            document.getElementById('game-title').innerText = "501 Match";
            document.getElementById('hud-label-1').innerText = "Remaining";
            document.getElementById('hud-val-1').innerText = "501";
            document.getElementById('hud-label-2').innerText = "Darts";
            document.getElementById('hud-val-2').innerText = "0";
            document.getElementById('btn-action').innerText = "Reset Board";
            Speaker.speak("Game on.");
        } 
        else if (mode === 'practice') {
            document.getElementById('game-title').innerText = "Heatmap Practice";
            document.getElementById('hud-label-1').innerText = "Hits";
            document.getElementById('hud-val-1').innerText = "0";
            document.getElementById('hud-label-2').innerText = "";
            document.getElementById('hud-val-2').innerText = "";
            document.getElementById('btn-action').innerText = "Clear Heatmap";
            Speaker.speak("Practice mode.");
        }
        else if (mode === 'cricket') {
            document.getElementById('game-title').innerText = "Cricket (Count Up)";
            document.getElementById('hud-label-1').innerText = "Score";
            document.getElementById('hud-val-1').innerText = "0";
            document.getElementById('hud-label-2').innerText = "";
            document.getElementById('hud-val-2').innerText = "";
            document.getElementById('btn-action').innerText = "Reset";
            this.setupCricketUI();
            Speaker.speak("Cricket. Aim for 20s.");
        }
        else if (mode === 'career') {
            document.getElementById('game-title').innerText = "Coach Mode";
            document.getElementById('hud-label-1').innerText = "Target";
            document.getElementById('hud-label-2').innerText = "Progress";
            document.getElementById('btn-action').innerText = "Skip Drill";
            this.loadCareerMission(); 
        }
    },

    resetState: function() {
        this.state = {
            score: 501,
            throws: 0,
            cricket: { 20:0, 19:0, 18:0, 17:0, 16:0, 15:0, 25:0, score:0 },
            careerLevel: 0,
            mission: null
        };
        this.historyStack = [];
    },

    saveHistory: function() {
        // Deep copy state for undo
        this.historyStack.push(JSON.parse(JSON.stringify(this.state)));
        if(this.historyStack.length > 10) this.historyStack.shift();
    },

    undo: function() {
        if(this.historyStack.length === 0) {
            Speaker.speak("Nothing to undo.");
            return;
        }
        // Restore state
        this.state = this.historyStack.pop();
        
        // Refresh UI based on restored state
        if(this.mode === 'x01') {
            document.getElementById('hud-val-1').innerText = this.state.score;
            document.getElementById('hud-val-2').innerText = this.state.throws;
            const hintBox = document.getElementById('checkout-box');
            if(this.state.score <= 170 && CHECKOUTS[this.state.score]) {
                hintBox.style.display = 'block';
                hintBox.innerText = "Try: " + CHECKOUTS[this.state.score];
            } else { hintBox.style.display = 'none'; }
        }
        else if(this.mode === 'practice') {
            document.getElementById('hud-val-1').innerText = this.state.throws;
        }
        else if(this.mode === 'cricket') {
            document.getElementById('hud-val-1').innerText = this.state.cricket.score;
            this.updateCricketUI();
        }
        else if(this.mode === 'career') {
            document.getElementById('hud-val-1').innerText = `Target: ${this.state.mission.target}`;
            document.getElementById('hud-val-2').innerText = `${this.state.mission.hits}/${this.state.mission.goal}`;
        }
        Speaker.speak("Undone.");
    },

    handleHit: function(score, type, event) {
        this.saveHistory(); 

        // Visual Feedback (Heatmap)
        if((this.mode === 'practice' || this.mode === 'career') && event) {
            BoardRenderer.addHeatmapDot(event.clientX, event.clientY);
        }

        let points = score;
        if(type === 'D') points *= 2;
        if(type === 'T') points *= 3;
        
        let label = "Miss";
        if(score > 0) {
            label = (type === 'T' ? 'Treble ' : type === 'D' ? 'Double ' : '') + score;
        }
        document.getElementById('status-msg').innerText = `Hit: ${label}`;

        // Logic routing
        if(this.mode === 'x01') this.logicX01(points, type, score);
        if(this.mode === 'practice') this.logicPractice(points);
        if(this.mode === 'cricket') this.logicCricket(score, type);
        if(this.mode === 'career') this.logicCareer(score, type);
    },

    // --- LOGIC MODULES ---

    logicX01: function(points, type, rawScore) {
        this.state.throws++;
        const remaining = this.state.score - points;

        if (remaining === 0 && type === 'D') {
            this.state.score = 0;
            Speaker.speak(`Game shot!`);
            alert("WINNER!");
            this.loadMode('x01'); 
            return;
        }

        if (remaining < 2 && remaining !== 0) {
            Speaker.speak("Bust!");
        } else {
            this.state.score = remaining;
            Speaker.speak(points > 0 ? `${points}` : "Miss");
        }

        document.getElementById('hud-val-1').innerText = this.state.score;
        document.getElementById('hud-val-2').innerText = this.state.throws;
        
        // Hints
        const hintBox = document.getElementById('checkout-box');
        if(this.state.score <= 170 && CHECKOUTS[this.state.score]) {
            hintBox.style.display = 'block';
            hintBox.innerText = "Try: " + CHECKOUTS[this.state.score];
        } else {
            hintBox.style.display = 'none';
        }
    },

    logicPractice: function(points) {
        this.state.throws++;
        document.getElementById('hud-val-1').innerText = this.state.throws;
    },

    logicCricket: function(score, type) {
        // Numbers: 15-20, Bull (25)
        if (score < 15 && score !== 25) return; 

        let hits = 1;
        if(type === 'D') hits = 2;
        if(type === 'T') hits = 3;

        const current = this.state.cricket[score];
        
        if (current < 3) {
            const needed = 3 - current;
            const used = Math.min(hits, needed);
            this.state.cricket[score] += used;
            hits -= used; 
        }

        if (hits > 0 && this.state.cricket[score] >= 3) {
            const pointsScored = (hits * (score === 25 ? 25 : score));
            this.state.cricket.score += pointsScored;
            Speaker.speak(`${pointsScored} points`);
        }

        document.getElementById('hud-val-1').innerText = this.state.cricket.score;
        this.updateCricketUI();
    },

    setupCricketUI: function() {
        const ui = document.getElementById('cricket-ui');
        ui.style.display = 'flex';
        ui.innerHTML = '';
        [20, 19, 18, 17, 16, 15, 25].forEach(num => {
            const div = document.createElement('div');
            div.className = 'cricket-col';
            div.innerHTML = `<div class="cricket-num" id="cric-${num}">${num===25?'B':num}</div><div id="mark-${num}" style="font-size:1.2rem; font-weight:bold;"></div>`;
            ui.appendChild(div);
        });
        this.updateCricketUI();
    },

    updateCricketUI: function() {
        [20, 19, 18, 17, 16, 15, 25].forEach(num => {
            const count = this.state.cricket[num];
            const el = document.getElementById(`mark-${num}`);
            let sym = '';
            if(count === 1) sym = '/';
            if(count === 2) sym = 'X';
            if(count >= 3) sym = '‚¶ª'; // Corrected symbol
            el.innerText = sym;
            if(count >= 3) {
                document.getElementById(`cric-${num}`).classList.add('cricket-mark');
                el.style.color = 'var(--text-dim)';
            } else {
                el.style.color = 'var(--primary)';
            }
        });
    },

    // --- CAREER MODULE ---

    loadCareerMission: function() {
        if(!this.state.mission) {
            this.state.mission = { target: 20, hits: 0, goal: 5 };
        }
        this.updateCareerUI();
        Speaker.speak(`Coach mode. Hit Single ${this.state.mission.target} five times.`);
    },

    logicCareer: function(score, type) {
        if(!this.state.mission) this.loadCareerMission();

        if(score === this.state.mission.target && type === 'S') {
            this.state.mission.hits++;
            Speaker.speak("Yes.");
            
            if(this.state.mission.hits >= this.state.mission.goal) {
                // Level Up
                this.state.mission.target--; 
                this.state.mission.hits = 0;
                if(this.state.mission.target < 10) {
                     Speaker.speak("Training complete. You are ready.");
                     alert("Session Complete!");
                     this.goHome();
                     return;
                }
                Speaker.speak(`Good. Next target: ${this.state.mission.target}`);
                BoardRenderer.render('board-container', this.handleHit.bind(this));
            }
        }
        this.updateCareerUI();
    },

    updateCareerUI: function() {
        document.getElementById('hud-val-1').innerText = `Single ${this.state.mission.target}`;
        document.getElementById('hud-val-2').innerText = `${this.state.mission.hits}/${this.state.mission.goal}`;
    },

    handleAction: function() {
        if(this.mode === 'practice' || this.mode === 'career') {
            BoardRenderer.render('board-container', this.handleHit.bind(this));
            this.state.throws = 0;
            if(this.mode === 'practice') document.getElementById('hud-val-1').innerText = 0;
        }
        else if (this.mode === 'x01') {
             BoardRenderer.render('board-container', this.handleHit.bind(this));
        }
        else if (this.mode === 'cricket') {
            this.loadMode('cricket'); 
        }
    }
};

// Start
app.goHome();

</script>
</body>
</html>