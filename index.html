<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DartsOS v17.0: Tournament & Pro Stats</title>
    <style>
        :root {
            --bg: #121212; --panel: #1e1e1e; --primary: #00e676; --secondary: #2979ff; --danger: #ff1744;
            --text-main: #ffffff; --text-dim: #b0bec5; --highlight: #ffd700;
        }
        body { 
            background: var(--bg); color: var(--text-main); font-family: system-ui, -apple-system, sans-serif; 
            margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; user-select: none; 
        }
        .screen { display: none; flex-direction: column; height: 100%; width: 100%; }
        .screen.active { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        header { 
            padding: 15px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; flex-shrink: 0; 
        }
        
        .icon-btn { background: #333; color: #aaa; border: 1px solid #444; border-radius: 8px; padding: 8px 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; transition: all 0.2s; }
        .icon-btn.active { background: var(--primary); color: black; border-color: var(--primary); }
        .icon-btn.listening { background: var(--danger); color: white; animation: pulse 1.5s infinite; }
        
        .main-area { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 10px; overflow-y: auto; padding-bottom: 40px; position: relative; }
        
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; max-width: 600px; margin-bottom: 20px; }
        .menu-card { background: var(--panel); border: 1px solid #333; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; position: relative; overflow: hidden; }
        .menu-card:active { transform: scale(0.98); border-color: var(--primary); }
        
        .chart-container { width: 100%; max-width: 600px; height: 150px; background: #222; border-radius: 12px; margin-top: 10px; position: relative; border: 1px solid #333; }
        
        .hud-panel { width: 100%; max-width: 600px; background: var(--panel); border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: flex-start; flex-shrink: 0; transition: all 0.3s; }
        .hud-score-box { text-align: center; flex: 1; transition: opacity 0.3s; cursor: pointer; }
        .hud-score-box.inactive { opacity: 0.4; }
        .hud-score { font-size: 2.5rem; font-weight: bold; color: var(--primary); line-height: 1; }
        .hud-label { font-size: 0.8rem; color: var(--text-dim); text-transform: uppercase; font-weight: bold; }
        .bot-score { color: var(--danger); }
        
        .hud-meta { font-size: 0.8rem; color: #888; margin-top: 5px; height: 20px; }
        .checkout-hint { 
            background: #2e7d32; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.9rem; font-weight: bold; 
            margin-top: 5px; display: inline-block; min-height: 20px; border: 1px solid #4caf50; 
        }
        
        #board-container { width: 100%; max-width: 450px; aspect-ratio: 1/1; position: relative; margin: 10px 0; flex-shrink: 0; display: block; }
        svg { width: 100%; height: 100%; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); touch-action: manipulation; }
        
        #numpad-container { width: 100%; max-width: 450px; height: 400px; display: none; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 10px 0; }
        .pad-btn { background: #333; color: white; border: none; border-radius: 8px; font-size: 1.5rem; font-weight: bold; cursor: pointer; }
        .pad-btn:active { background: var(--primary); color: black; }
        .pad-enter { background: var(--primary); color: black; grid-column: span 3; }
        
        .controls { 
            display: flex; gap: 10px; width: 100%; max-width: 450px; 
            padding-bottom: env(safe-area-inset-bottom, 20px); margin-top: auto; flex-shrink: 0; 
        }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; background: #333; color: white; }
        .btn-primary { background: var(--primary); color: black; }
        .btn-miss { background: #424242; color: #ff5252; border: 1px solid #ff5252; flex: 0.4; }
        .rank-badge { background: var(--highlight); color: black; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; position: absolute; top: 10px; right: 10px; }
        
        /* COACH UI */
        .coach-avatar { font-size: 3rem; margin-bottom: 10px; }
        .coach-msg { font-size: 1.1rem; color: #fff; line-height: 1.5; margin-bottom: 20px; text-align: left; background: #222; padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary); }
        .coach-rec { font-weight: bold; color: var(--highlight); display: block; margin-top: 10px; font-size: 0.9rem; }

        /* OVERLAYS */
        #setup-modal, #report-modal, #history-modal, #coach-modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 100; justify-content: center; align-items: center; 
            overflow-y: auto; padding: 20px; box-sizing: border-box;
        }
        .modal-card { background: var(--panel); padding: 30px; border-radius: 12px; text-align: center; width: 100%; max-width: 400px; border: 1px solid #333; }
        .modal-row { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        select { background: #333; color: white; padding: 10px; border: 1px solid #555; border-radius: 6px; font-size: 1.1rem; width: 150px; }
        
        /* PRO STATS GRID */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        .stat-item { background: #222; padding: 10px; border-radius: 6px; }
        .stat-val { color: var(--primary); font-size: 1.5rem; font-weight: bold; display: block; }
        .stat-lbl { color: #888; font-size: 0.8rem; }
        .stat-row { display:flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .stat-row span { font-size: 0.9rem; }
        .stat-row strong { color: var(--highlight); }

        /* HISTORY LIST */
        .history-list { text-align: left; max-height: 400px; overflow-y: auto; margin-bottom: 20px; }
        .hist-row { padding: 10px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .hist-win { border-left: 4px solid var(--primary); }
        .hist-loss { border-left: 4px solid var(--danger); }
        .hist-date { font-size: 0.8rem; color: #666; display: block; }
        .hist-details { font-size: 0.9rem; color: white; }

        /* CRICKET UI - COMPACT */
        #cricket-board { display: none; width: 100%; max-width: 450px; margin-bottom: 10px; background: #222; border-radius: 8px; overflow: hidden; }
        .crick-row { display: flex; border-bottom: 1px solid #333; height: 35px; align-items: center; }
        .crick-num { flex: 1; text-align: center; font-weight: bold; color: #aaa; background: #2a2a2a; height: 100%; display: flex; align-items: center; justify-content: center; border-left: 1px solid #333; border-right: 1px solid #333; }
        .crick-mk { flex: 2; text-align: center; color: white; font-weight: bold; font-family: monospace; font-size: 1.2rem; }
        .crick-mk.closed { color: #555; }
        .crick-header { background: #333; color: var(--highlight); font-size: 0.8rem; height: 30px; }

        /* 180 ANIMATION */
        #max-overlay {
            display: none; position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(255, 215, 0, 0.2); pointer-events: none;
            justify-content: center; align-items: center; z-index: 50;
            animation: flash 0.5s infinite alternate;
        }
        .max-text { font-size: 5rem; font-weight: 900; color: #ffd700; text-shadow: 0 0 20px #fff; transform: rotate(-15deg); }
        @keyframes flash { from { opacity: 0.5; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="setup-modal">
    <div class="modal-card">
        <h2 id="setup-title">Match Setup</h2>
        
        <div id="setup-league" class="setup-group">
            <div class="modal-row" id="row-opponent">
                <span>Opponent</span>
                <select id="set-bot-level"></select>
            </div>
            <div class="modal-row">
                <span>Start Score</span>
                <select id="set-score">
                    <option value="301">301</option>
                    <option value="501" selected>501</option>
                    <option value="701">701</option>
                </select>
            </div>
            <div class="modal-row">
                <span>Format</span>
                <select id="set-legs">
                    <option value="1">1 Leg</option>
                    <option value="3" selected>Best of 3</option>
                    <option value="5">Best of 5</option>
                </select>
            </div>
        </div>

        <div id="setup-rtc" class="setup-group" style="display:none">
            <div class="modal-row">
                <span>Difficulty</span>
                <select id="set-rtc-mode">
                    <option value="S">Singles (Standard)</option>
                    <option value="D">Doubles (Pro)</option>
                    <option value="T">Trebles (Elite)</option>
                </select>
            </div>
        </div>

        <button class="btn btn-primary" onclick="app.confirmSetup()">START</button>
        <button class="btn" style="margin-top:10px;background:#333" onclick="app.closeSetup()">Cancel</button>
    </div>
</div>

<div id="report-modal">
    <div class="modal-card" style="max-width:450px;">
        <h2>Match Report</h2>
        <h3 id="report-result" style="color:var(--primary); font-size: 2rem; margin: 10px 0;">VICTORY</h3>
        <p id="tourney-msg" style="color:#aaa; font-style:italic; margin-bottom:15px; display:none;">Tournament Round 1 Complete</p>
        
        <div class="stat-grid">
            <div class="stat-item">
                <span class="stat-val" id="rep-avg">0.0</span>
                <span class="stat-lbl">3-Dart Avg</span>
            </div>
            <div class="stat-item">
                <span class="stat-val" id="rep-first9">0.0</span>
                <span class="stat-lbl">First 9 Avg</span>
            </div>
            <div class="stat-item">
                <span class="stat-val" id="rep-doubles">0%</span>
                <span class="stat-lbl">Checkout</span>
            </div>
            <div class="stat-item">
                <span class="stat-val" id="rep-score">0-0</span>
                <span class="stat-lbl">Score</span>
            </div>
        </div>
        
        <div style="background:#222; padding:15px; border-radius:8px; text-align:left; margin-bottom:20px;">
            <div class="stat-row"><span>Tons (100+)</span><strong id="rep-100">0</strong></div>
            <div class="stat-row"><span>Super Tons (140+)</span><strong id="rep-140">0</strong></div>
            <div class="stat-row" style="border:none"><span>Maximums (180)</span><strong id="rep-180" style="color:var(--highlight)">0</strong></div>
        </div>

        <button class="btn btn-primary" id="btn-report-next" onclick="app.closeReport()">Main Menu</button>
    </div>
</div>

<div id="coach-modal">
    <div class="modal-card">
        <div class="coach-avatar">üéì</div>
        <h2>Coach's Analysis</h2>
        <div id="coach-content" class="coach-msg">
            Loading analysis...
        </div>
        <button class="btn btn-primary" onclick="document.getElementById('coach-modal').style.display='none'">Thanks Coach</button>
    </div>
</div>

<div id="history-modal">
    <div class="modal-card" style="max-width: 500px;">
        <h2>Career History</h2>
        <div class="history-list" id="history-list"></div>
        <button class="btn btn-primary" onclick="document.getElementById('history-modal').style.display='none'">Close</button>
        <button class="btn" style="margin-top:10px; background:#444;" onclick="Stats.exportData()">Download Data</button>
    </div>
</div>

<div id="screen-menu" class="screen active">
    <header>
        <h1>üéØ DartsOS <span style="font-size:0.6em; background:var(--primary); color:#000; padding:2px 6px; border-radius:4px;">v17.0</span></h1>
        <div style="display:flex; gap:10px;">
            <div class="icon-btn" onclick="Coach.analyze()">üéì</div>
            <div id="settings-btn" class="icon-btn" onclick="Stats.showHistory()">üìä</div>
        </div>
    </header>
    <div class="main-area">
        <div style="width:100%; max-width:600px; display:flex; justify-content:space-between; align-items:end; margin-top:10px;">
            <span style="font-size:0.9rem; color:#aaa;">Performance Trend</span>
            <span id="current-avg-display" style="font-weight:bold; color:var(--primary)">Avg: --</span>
        </div>
        <div class="chart-container" id="chart-area"></div>
        
        <h2 style="margin-top: 20px;">Game Modes</h2>
        <div class="menu-grid">
            <div class="menu-card" style="grid-column: span 2; background: linear-gradient(135deg, #1e1e1e, #2c1e1e); border-color: var(--highlight);" onclick="app.startTournament()">
                <span style="font-size:2rem">üèÜ</span><br><b style="color:var(--highlight)">TOURNAMENT</b><br><span style="font-size:0.8rem; color:#aaa">Win the Cup</span>
            </div>
            
            <div class="menu-card" onclick="app.openSetup('league')">
                <span class="rank-badge" id="league-rank">ROOKIE</span><span style="font-size:2rem">üèÖ</span><br><b>Bot League</b><br><span style="font-size:0.8rem; color:#888">Single Match</span>
            </div>
            <div class="menu-card" onclick="app.openSetup('rtc')">
                <span style="font-size:2rem">‚è∞</span><br><b>Round The Clock</b><br><span style="font-size:0.8rem; color:#888">Accuracy Drill</span>
            </div>
            <div class="menu-card" onclick="app.loadMode('cricket')">
                <span style="font-size:2rem">ü¶ó</span><br><b>Cricket</b><br><span style="font-size:0.8rem; color:#888">Tactical Attack</span>
            </div>
            <div class="menu-card" onclick="app.loadMode('jdc')">
                <span style="font-size:2rem">ü•ã</span><br><b>JDC Academy</b><br><span style="font-size:0.8rem; color:#888">Official Routine</span>
            </div>
            <div class="menu-card" onclick="app.loadMode('bobs27')">
                <span style="font-size:2rem">‚ò†Ô∏è</span><br><b>Bob's 27</b><br><span style="font-size:0.8rem; color:#888">Doubles Practice</span>
            </div>
            <div class="menu-card" onclick="app.openSetup('pvp')">
                <span style="font-size:2rem">üë•</span><br><b>Vs Player</b><br><span style="font-size:0.8rem; color:#888">Pass & Play</span>
            </div>
        </div>
        <button class="btn" style="background:#222; margin-top:10px; font-size:0.8rem" onclick="Stats.clear()">Reset Career</button>
    </div>
</div>

<div id="screen-game" class="screen">
    <header>
        <h1 id="game-title">Game</h1>
        <div style="display:flex; gap:10px; align-items:center;">
            <div id="input-toggle" class="icon-btn" onclick="app.toggleInput()">üéØ</div>
            <div id="mic-toggle-game" class="icon-btn" onclick="Voice.toggle()">üéôÔ∏è</div>
            <div id="restart-game" class="icon-btn" onclick="app.resetLeg()">‚Ü∫</div>
            <button class="btn" style="width: auto; padding: 5px 15px; font-size: 0.8rem;" onclick="app.goHome()">Exit</button>
        </div>
    </header>
    <div class="main-area">
        <div id="max-overlay"><div class="max-text">180!</div></div>
        
        <div class="hud-panel" id="main-hud">
            <div class="hud-score-box" id="p1-box" onclick="app.renameUser()">
                <div class="hud-label" id="hud-lbl-1">YOU</div>
                <div class="hud-score" id="hud-val-1">501</div>
                <div class="hud-meta" id="p1-meta"></div>
                <div class="checkout-hint" id="checkout-display"></div>
            </div>
            <div class="leg-score" id="match-score-display">0 - 0</div>
            <div class="hud-score-box" id="p2-box">
                <div class="hud-label" id="hud-lbl-2">BOT</div>
                <div class="hud-score bot-score" id="hud-val-2">501</div>
                <div class="hud-meta" id="p2-meta"></div>
                <div class="hud-label" id="hud-sub-2"></div>
            </div>
        </div>

        <div id="cricket-board"></div>
        <div id="board-container"></div>
        
        <div id="numpad-container">
            <button class="pad-btn" onclick="app.numpadAdd(1)">1</button><button class="pad-btn" onclick="app.numpadAdd(2)">2</button><button class="pad-btn" onclick="app.numpadAdd(3)">3</button>
            <button class="pad-btn" onclick="app.numpadAdd(4)">4</button><button class="pad-btn" onclick="app.numpadAdd(5)">5</button><button class="pad-btn" onclick="app.numpadAdd(6)">6</button>
            <button class="pad-btn" onclick="app.numpadAdd(7)">7</button><button class="pad-btn" onclick="app.numpadAdd(8)">8</button><button class="pad-btn" onclick="app.numpadAdd(9)">9</button>
            <button class="pad-btn" style="color:#ff5252" onclick="app.numpadClear()">CLR</button><button class="pad-btn" onclick="app.numpadAdd(0)">0</button>
            <button class="pad-enter" onclick="app.numpadSubmit()">ENTER</button>
        </div>

        <div id="status-msg" style="height:20px; color:#aaa; font-style:italic;">Target: Open</div>

        <div class="controls" id="touch-controls">
            <button class="btn" onclick="app.undo()">Undo</button>
            <button class="btn btn-miss" onclick="app.handleHit(0, 'MISS', null)">Miss</button>
            <button class="btn btn-primary" id="btn-next" onclick="app.handleAction()">Next Round</button>
        </div>
    </div>
</div>

<script>
// --- CONFIGURATION ---
const BOTS = [
    { name: "Pub Rookie", avg: 35, checkout: 0.1 },
    { name: "Local Champ", avg: 45, checkout: 0.2 },
    { name: "County Player", avg: 55, checkout: 0.4 },
    { name: "Semi-Pro", avg: 70, checkout: 0.6 },
    { name: "The Iceman", avg: 95, checkout: 0.9 }
];

// --- STRATEGIST ---
const Strategist = {
    routes: {
        170:"T20 T20 Bull", 167:"T20 T19 Bull", 164:"T20 T18 Bull", 161:"T20 T17 Bull",
        130:"T20 T18 D8", 129:"T19 T16 D12", 128:"T18 T14 D16", 127:"T20 T17 D8", 126:"T19 T19 D6", 125:"Bull T17 D12", 124:"T20 T16 D8", 123:"T19 T16 D9", 122:"T18 T20 D4", 121:"T20 T11 D14", 120:"T20 20 D20"
    },
    getCheckout: function(score) {
        if (score > 170 || score < 2) return "";
        if ([169, 168, 166, 165, 163, 162, 159].includes(score)) return "No checkout";
        if (this.routes[score]) return this.routes[score];
        if (score <= 40 && score % 2 === 0) return "D" + (score / 2);
        if (score === 50) return "Bullseye";
        for (let first = 60; first >= 1; first--) {
            let rem = score - first;
            if (rem >= 2 && rem <= 40 && rem % 2 === 0) {
                let firstTxt = first;
                if(first % 3 === 0 && first > 20) firstTxt = "T" + (first/3);
                else if(first > 20 && first !== 25 && first !== 50) continue;
                return `${firstTxt} D${rem/2}`;
            }
        }
        return "Setup shot";
    }
};

// --- AUDIO ---
const SFX = {
    ctx: null,
    init: function() {
        if (!this.ctx) {
            const C = window.AudioContext || window.webkitAudioContext;
            if (C) this.ctx = new C();
        }
    },
    playThud: function() {
        if (navigator.vibrate) navigator.vibrate(40);
        this.init();
        if (!this.ctx) return;
        try {
            if(this.ctx.state === 'suspended') this.ctx.resume();
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain); gain.connect(this.ctx.destination);
            osc.frequency.setValueAtTime(150, this.ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(40, this.ctx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.5, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
            osc.start(); osc.stop(this.ctx.currentTime + 0.1);
        } catch (e) {}
    }
};

const Speaker = {
    speak: function(e, t) {
        if(!window.speechSynthesis) return;
        window.speechSynthesis.cancel();
        if (180 === t) {
            const t=new SpeechSynthesisUtterance("ONE HUNDRED AND EIGHTY!");return t.pitch=.8,t.volume=1,void window.speechSynthesis.speak(t)
        }
        const o=new SpeechSynthesisUtterance(e);t>=100?o.pitch=.9:t>=60?o.pitch=1:o.pitch=1.1,window.speechSynthesis.speak(o)
    }
};

// --- VOICE ---
const Voice = {
    recognition: null, isListening: false,
    init: function() {
        if (!("webkitSpeechRecognition" in window)) return;
        const e = window.webkitSpeechRecognition;
        this.recognition = new e; this.recognition.continuous = !0; this.recognition.lang = "en-US";
        this.recognition.onresult = e => this.processCommand(e.results[e.results.length - 1][0].transcript);
        this.recognition.onend = () => { if(this.isListening) this.recognition.start(); };
    },
    toggle: function() {
        if (!this.recognition) this.init();
        if (!this.recognition) return alert("Voice not supported on this device");
        this.isListening ? (this.recognition.stop(), this.isListening = !1) : (this.recognition.start(), this.isListening = !0);
        const e = this.isListening ? "icon-btn listening" : "icon-btn";
        const m = document.getElementById("mic-toggle-menu"); const g = document.getElementById("mic-toggle-game");
        if(m) m.className = e; if(g) g.className = e;
    },
    processCommand: function(e) {
        const t = e.toLowerCase().trim();
        if (t.includes("next")) return app.handleAction();
        let o = "S"; if(t.includes("double")) o = "D"; if(t.includes("triple")) o = "T";
        let n = 0;
        if (t.includes("bull")) n = 50; else if (t.includes("25")) n = 25;
        else { const m = t.match(/(\d+)/); if (m) n = parseInt(m[0]); }
        if (n > 0 && n <= 50) { if (n === 50) { n = 25; o = "D"; } app.handleHit(n, o); }
    }
};

// --- COACH LOGIC ---
const Coach = {
    analyze: function() {
        const m = Stats.data.matches;
        const heat = Stats.data.heatmap;
        const box = document.getElementById("coach-content");
        document.getElementById("coach-modal").style.display = "flex";

        if(m.length < 3) {
            box.innerHTML = "I need more data! Play at least 3 matches so I can analyze your throw.";
            return;
        }

        let driftMsg = "Your grouping is centered.";
        if(heat.length > 10) {
            let sumX = 0;
            heat.forEach(p => sumX += p.x);
            const avgX = sumX / heat.length;
            if(avgX < 240) driftMsg = "You are drifting left (into the 5s). Check your elbow is vertical and not flaring out.";
            if(avgX > 260) driftMsg = "You are drifting right (into the 1s). You might be snatching the dart upon release.";
        }

        const last5 = m.slice(-5);
        const avg = last5.reduce((a,b)=>a+b.avg,0)/last5.length;
        const wins = last5.filter(x=>x.result==="W").length;
        
        let doubleSum = 0, doubleCount = 0;
        last5.forEach(x => { if(x.checkoutPerc > 0) { doubleSum+=x.checkoutPerc; doubleCount++; } });
        const dblPerc = doubleCount > 0 ? doubleSum/doubleCount : 0;

        let advice = "";
        let rec = "";

        if(dblPerc < 15) {
            advice = "Your scoring is okay, but missed doubles are killing your game.";
            rec = "RECOMMENDATION: Play 'Bob's 27' twice daily until you can finish with a positive score.";
        } else if (avg < 40) {
            advice = "We need to build your scoring consistency. You're hitting too many low numbers.";
            rec = "RECOMMENDATION: Play 'Round The Clock' (Singles) to build muscle memory around the board.";
        } else if (wins === 0) {
            advice = "You're on a losing streak. It happens. You might be playing bots that are too hard.";
            rec = "RECOMMENDATION: Drop the Bot Level down one notch to rebuild confidence.";
        } else {
            advice = "You are playing well! Consistency is high.";
            rec = "RECOMMENDATION: Try the 'JDC Academy' routine to test yourself against pro standards.";
        }

        box.innerHTML = `
            <b>Recent Form (Last 5):</b> Avg ${avg.toFixed(1)} | Doubles ${Math.round(dblPerc)}%<br><br>
            ${driftMsg}<br><br>
            ${advice}
            <span class="coach-rec">${rec}</span>
        `;
    }
};

// --- STATS ---
const Stats = {
    data: { matches: [], leagueRank: 0, drillLevel: 0, heatmap: [], userName: "YOU", bestLeg: 999, highOut: 0 },
    load: function() {
        try {
            const e = localStorage.getItem("darts_v16");
            if (e) this.data = JSON.parse(e);
            if(!this.data.userName || this.data.userName === "undefined") this.data.userName = "YOU";
            if (this.data.bestLeg < 6) { this.data.bestLeg = 999; this.save(); }
        } catch(e) {}
        this.renderChart(); this.updateBadges();
    },
    save: function() { localStorage.setItem("darts_v16", JSON.stringify(this.data)) },
    setName: function(n) { this.data.userName = n; this.save(); },
    addMatch: function(avg, res, doubles = 0, missed = 0) {
        const opponent = app.mode === "league" && app.settings.botIdx !== undefined ? BOTS[app.settings.botIdx].name : "Player 2";
        this.data.matches.push({ 
            date: new Date().toLocaleDateString(), avg: parseFloat(avg), result: res, 
            type: "x01", opponent: opponent, checkoutPerc: missed+doubles > 0 ? Math.round((doubles / (doubles+missed))*100) : 0
        });
        if (this.data.matches.length > 50) this.data.matches.shift();
        this.save();
    },
    updateRecords: function(darts, checkout) {
        if (darts >= 6 && darts < this.data.bestLeg) this.data.bestLeg = darts;
        if (checkout > this.data.highOut) this.data.highOut = checkout;
        this.save();
    },
    addHeatmapPoint: function(x, y) {
        this.data.heatmap.push({x, y});
        if (this.data.heatmap.length > 2000) this.data.heatmap.shift();
        this.save();
    },
    updateLeague: function(e) { if(e === this.data.leagueRank){ this.data.leagueRank++; this.save(); } },
    showHistory: function() {
        const list = document.getElementById("history-list");
        list.innerHTML = "";
        [...this.data.matches].reverse().forEach(m => {
            const cls = m.result === "W" ? "hist-win" : "hist-loss";
            list.innerHTML += `<div class="hist-row ${cls}"><div><span class="hist-date">${m.date} vs ${m.opponent}</span><div class="hist-details">Avg: ${m.avg} | Checkout: ${m.checkoutPerc}%</div></div><div style="font-weight:bold;font-size:1.2rem;">${m.result}</div></div>`;
        });
        document.getElementById("history-modal").style.display = "flex";
    },
    exportData: function() {
        const e = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.data));
        const t = document.createElement("a"); t.href = e; t.download = "dartsos_backup.json"; document.body.appendChild(t); t.click(); t.remove();
    },
    clear: function() { if(confirm("Reset all data?")) { localStorage.removeItem("darts_v16"); location.reload(); } },
    renderChart: function() {
        const e = document.getElementById("chart-area");
        const t = this.data.matches.filter(x => x.type === "x01");
        if (t.length < 2) return e.innerHTML = "<div style='padding:60px;text-align:center;color:#555'>Play matches to see stats</div>";
        const avgs = t.map(x => x.avg);
        const w = 600, h = 150; let pts = "";
        avgs.forEach((val, i) => { pts += `${i/(avgs.length-1)*w},${h-(val-20)/(100)*h} `; });
        const last3 = avgs.slice(-3);
        const curr = (last3.reduce((a,b)=>a+b,0)/last3.length).toFixed(1);
        document.getElementById("current-avg-display").innerText = "Avg: " + curr;
        e.innerHTML = `<svg width="100%" height="100%" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none"><polyline points="${pts}" stroke="#00e676" fill="none" stroke-width="2"/></svg>`;
    },
    updateBadges: function() {
        const e = ["ROOKIE", "AMATEUR", "SEMI-PRO", "PRO", "ELITE"];
        document.getElementById("league-rank").innerText = e[Math.min(4, this.data.leagueRank)];
    }
};

// --- RENDERER ---
const BoardRenderer = {
    render: function(cb, showHeat, markers=[]) {
        const container = document.getElementById("board-container");
        container.innerHTML = "";
        const n = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        n.setAttribute("viewBox", "0 0 500 500"); n.id = "dartboard-svg";
        const a = [20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5], r = 250;

        function i(t, o, i, d, c) {
            const s = 360 / 20;
            a.forEach((a, l) => {
                const u = (l * s - s / 2) * Math.PI / 180 - Math.PI / 2, h = (l * s + s / 2) * Math.PI / 180 - Math.PI / 2,
                    p = `M${r+t*Math.cos(u)},${r+t*Math.sin(u)} L${r+o*Math.cos(u)},${r+o*Math.sin(u)} A${o},${o} 0 0,1 ${r+o*Math.cos(h)},${r+o*Math.sin(h)} L${r+t*Math.cos(h)},${r+t*Math.sin(h)} A${t},${t} 0 0,0 ${r+t*Math.cos(u)},${r+t*Math.sin(u)}Z`,
                    g = document.createElementNS("http://www.w3.org/2000/svg", "path");
                g.setAttribute("d", p), g.setAttribute("fill", l % 2 == 0 ? d : c), g.onclick = t => cb(a, i, t), n.appendChild(g)
            })
        }
        i(162, 170, "D", "#e53935", "#43a047"), i(107, 162, "S", "#121212", "#eeeeee"), i(99, 107, "T", "#e53935", "#43a047"), i(16, 99, "S", "#121212", "#eeeeee");
        const outerBull = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        outerBull.setAttribute("cx", r), outerBull.setAttribute("cy", r), outerBull.setAttribute("r", 16), outerBull.setAttribute("fill", "#43a047"), outerBull.onclick = t => cb(25, "S", t), n.appendChild(outerBull);
        const innerBull = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        innerBull.setAttribute("cx", r), innerBull.setAttribute("cy", r), innerBull.setAttribute("r", 6), innerBull.setAttribute("fill", "#e53935"), innerBull.onclick = t => cb(25, "D", t), n.appendChild(innerBull);
        
        if(showHeat) Stats.data.heatmap.forEach(e => {
            const t = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            t.setAttribute("cx", e.x), t.setAttribute("cy", e.y), t.setAttribute("r", 2), t.setAttribute("fill", "rgba(255, 215, 0, 0.4)"), t.style.pointerEvents = "none", n.appendChild(t)
        });
        
        const colors = ["#ff1744", "#00e676", "#2979ff"];
        markers.forEach((m, idx) => {
            const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            dot.setAttribute("cx", m.x); dot.setAttribute("cy", m.y); dot.setAttribute("r", 5);
            dot.setAttribute("fill", colors[idx % 3]); dot.setAttribute("stroke", "white"); dot.setAttribute("stroke-width", "2");
            dot.style.pointerEvents = "none";
            n.appendChild(dot);
        });
        
        a.forEach((e, t) => {
            const o = document.createElementNS("http://www.w3.org/2000/svg", "text"), a = (360 * t / 20 - 90) * Math.PI / 180;
            o.setAttribute("x", r + 205 * Math.cos(a)), o.setAttribute("y", r + 205 * Math.sin(a)), o.setAttribute("text-anchor", "middle"), o.setAttribute("dominant-baseline", "middle"), o.setAttribute("fill", "white"), o.setAttribute("font-size", "24"), o.setAttribute("font-weight", "bold"), o.textContent = e, o.style.pointerEvents = "none", n.appendChild(o)
        });
        container.appendChild(n);
    }
};

// --- APP ---
const app = {
    mode: null, state: {}, inputMode: "board", numpadBuffer: "", settings: { score: 501, legs: 3, rtcMode: 'S', botIdx: 0 }, historyStack: [], markerList: [],
    // NEW TOURNAMENT STATE
    tournament: { active: false, round: 0 },
    
    goHome: function() {
        document.getElementById("screen-game").classList.remove("active");
        document.getElementById("screen-menu").classList.add("active");
        document.getElementById("report-modal").style.display = "none";
        // Reset Tourney if exiting mid-game
        this.tournament.active = false;
        Stats.load();
    },
    openSetup: function(mode) {
        this.mode = mode;
        this.tournament.active = false; // Reset tourney flag if regular setup is opened
        document.getElementById("setup-modal").style.display = "flex";
        document.getElementById("setup-title").innerText = mode === "rtc" ? "Round The Clock" : "Match Setup";
        document.getElementById("setup-league").style.display = mode === "rtc" ? "none" : "block";
        document.getElementById("setup-rtc").style.display = mode === "rtc" ? "block" : "none";
        
        const botSelect = document.getElementById("set-bot-level");
        const botRow = document.getElementById("row-opponent");
        
        if (mode === "league") {
            botRow.style.display = "flex";
            botSelect.innerHTML = "";
            BOTS.forEach((b, i) => {
                const opt = document.createElement("option");
                opt.value = i;
                opt.innerText = b.name;
                if (i === Math.min(4, Stats.data.leagueRank)) opt.selected = true;
                botSelect.appendChild(opt);
            });
        } else {
            botRow.style.display = "none";
        }
    },
    // NEW: START TOURNAMENT
    startTournament: function() {
        this.tournament = { active: true, round: 1 };
        this.mode = "league";
        this.settings.legs = 3; // Fixed format
        this.settings.score = 501;
        this.launchTournamentMatch();
    },
    launchTournamentMatch: function() {
        // Round 1: Easy (0 or 1), Round 2: Medium (2 or 3), Round 3: Iceman (4)
        let botIndex = 0;
        if (this.tournament.round === 1) botIndex = 0;
        else if (this.tournament.round === 2) botIndex = 2;
        else botIndex = 4;
        
        this.settings.botIdx = botIndex;
        this.loadMode("league");
    },
    
    closeSetup: function() { document.getElementById("setup-modal").style.display = "none"; },
    confirmSetup: function() {
        this.settings.score = parseInt(document.getElementById("set-score").value);
        this.settings.legs = parseInt(document.getElementById("set-legs").value);
        this.settings.rtcMode = document.getElementById("set-rtc-mode").value;
        this.settings.botIdx = parseInt(document.getElementById("set-bot-level").value); 
        this.closeSetup();
        this.loadMode(this.mode);
    },
    showReport: function(won, avg) {
        const r = document.getElementById("report-modal"); r.style.display = "flex";
        const resTitle = document.getElementById("report-result");
        const msg = document.getElementById("tourney-msg");
        const btn = document.getElementById("btn-report-next");

        // PRO STATS CALCULATIONS
        document.getElementById("rep-avg").innerText = avg;
        document.getElementById("rep-best").innerText = Stats.data.bestLeg === 999 ? "--" : Stats.data.bestLeg;
        const miss = this.state.matchMissedDoubles || 0; const hits = this.state.matchHitDoubles || 0;
        const rate = hits + miss > 0 ? Math.round((hits / (hits+miss))*100) + "%" : "--";
        document.getElementById("rep-doubles").innerText = rate;
        document.getElementById("rep-score").innerText = `${this.state.matchScore[0]} - ${this.state.matchScore[1]}`;
        
        // NEW STATS
        document.getElementById("rep-100").innerText = this.state.stats.tons;
        document.getElementById("rep-140").innerText = this.state.stats.superTons;
        document.getElementById("rep-180").innerText = this.state.stats.maxes;
        
        // First 9 Avg
        const f9 = this.state.stats.first9Darts > 0 
            ? ((this.state.stats.first9Score / this.state.stats.first9Darts) * 3).toFixed(1) 
            : "0.0";
        document.getElementById("rep-first9").innerText = f9;

        // TOURNAMENT LOGIC
        if (this.tournament.active) {
            msg.style.display = "block";
            if (won) {
                if (this.tournament.round === 3) {
                    resTitle.innerText = "CHAMPION!";
                    resTitle.style.color = "gold";
                    msg.innerText = "You won the DartsOS Cup!";
                    btn.innerText = "Claim Trophy";
                    btn.onclick = () => { this.tournament.active = false; this.closeReport(); };
                } else {
                    resTitle.innerText = "ROUND " + this.tournament.round + " CLEAR";
                    resTitle.style.color = "var(--primary)";
                    msg.innerText = "Advancing to next round...";
                    btn.innerText = "Next Match";
                    btn.onclick = () => { 
                        this.tournament.round++; 
                        document.getElementById("report-modal").style.display="none"; 
                        this.launchTournamentMatch(); 
                    };
                }
            } else {
                resTitle.innerText = "ELIMINATED";
                resTitle.style.color = "var(--danger)";
                msg.innerText = "Better luck next time.";
                btn.innerText = "Main Menu";
                btn.onclick = () => { this.tournament.active = false; this.closeReport(); };
            }
        } else {
            // REGULAR MODE
            msg.style.display = "none";
            resTitle.innerText = won ? "VICTORY" : "DEFEAT";
            resTitle.style.color = won ? "var(--primary)" : "var(--danger)";
            btn.innerText = "Main Menu";
            btn.onclick = () => { this.closeReport(); };
        }
    },
    closeReport: function() { document.getElementById("report-modal").style.display = "none"; this.goHome(); },
    renameUser: function() {
        const n = prompt("Enter your name:", Stats.data.userName);
        if(n) { Stats.setName(n); document.getElementById("hud-lbl-1").innerText = n; }
    },
    toggleInput: function() {
        this.inputMode = this.inputMode === "board" ? "numpad" : "board";
        const b = document.getElementById("board-container"), n = document.getElementById("numpad-container"), btn = document.getElementById("input-toggle");
        if (this.inputMode === "numpad") {
            b.style.display = "none"; n.style.display = "grid"; btn.innerText = "‚å®Ô∏è"; btn.classList.add("active");
        } else {
            b.style.display = "block"; n.style.display = "none"; btn.innerText = "üéØ"; btn.classList.remove("active");
        }
    },
    numpadAdd: function(e) { 
        if((this.numpadBuffer + e).length > 3) return; 
        if(parseInt(this.numpadBuffer + e) > 180) return; 
        this.numpadBuffer += e; 
        document.getElementById("status-msg").innerText = "Score: " + this.numpadBuffer; 
    },
    numpadClear: function() { this.numpadBuffer = ""; document.getElementById("status-msg").innerText = "Score: "; },
    numpadSubmit: function() {
        const e = parseInt(this.numpadBuffer);
        if (isNaN(e) || e > 180) { alert("Invalid"); this.numpadClear(); return; }
        if (this.mode === "league" || this.mode === "pvp") { this.state.dartsInTurn = 3; this.logicX01(e, "S", true); }
        this.numpadClear();
    },
    loadMode: function(e) {
        this.mode = e;
        const startS = this.settings.score || 501;
        this.state = {
            score: startS, p2Score: startS, startScore: startS, currentPlayer: 1, dartsInTurn: 0, turnScore: 0,
            legDarts: 0,
            matchScore: [0, 0], matchTotalScore: 0, matchTotalDarts: 0,
            matchMissedDoubles: 0, matchHitDoubles: 0,
            // NEW STATS COUNTERS
            stats: { tons: 0, superTons: 0, maxes: 0, first9Score: 0, first9Darts: 0 },
            
            targetList: [], targetIndex: 0, jdcLevel: 0, jdcScore: 0, rtcTarget: 1, rtcHits: 0,
            cricket: { 1: {20:0,19:0,18:0,17:0,16:0,15:0,25:0}, 2: {20:0,19:0,18:0,17:0,16:0,15:0,25:0}, s1:0, s2:0 },
            throwLog: [], trainerTarget: 0, trainerAttempts: 0
        };
        this.historyStack = []; this.markerList = [];
        
        document.getElementById("screen-menu").classList.remove("active");
        document.getElementById("screen-game").classList.add("active");
        
        BoardRenderer.render(this.handleHit.bind(this), "practice" === e);
        document.getElementById("main-hud").style.display = "flex";
        document.getElementById("p2-box").style.visibility = "hidden";
        document.getElementById("match-score-display").style.visibility = "hidden";
        document.getElementById("cricket-board").style.display = "none";
        document.getElementById("hud-lbl-1").innerText = Stats.data.userName;
        document.getElementById("checkout-display").innerText = "";
        document.getElementById("p1-meta").innerText = "";
        document.getElementById("p2-meta").innerText = "";
        document.getElementById("btn-next").innerText = "Next Round";

        if (e === "league") this.setupLeague();
        else if (e === "rtc") this.setupRTC();
        else if (e === "pvp") this.setupPvP();
        else if (e === "bobs27") this.setupBobs27();
        else if (e === "jdc") this.setupJDC();
        else if (e === "cricket") this.setupCricket();
        else if (e === "train_out") this.setupTrainer();
        else document.getElementById("game-title").innerText = "Analysis";
    },
    setupLeague: function() {
        const i = this.settings.botIdx !== undefined ? this.settings.botIdx : Math.min(4, Stats.data.leagueRank);
        this.state.botIdx = i;
        
        let title = `Vs ${BOTS[i].name}`;
        if(this.tournament.active) title = `Round ${this.tournament.round}: Vs ${BOTS[i].name}`;
        
        document.getElementById("game-title").innerText = title;
        document.getElementById("p2-box").style.visibility = "visible";
        document.getElementById("match-score-display").style.visibility = "visible";
        this.updateUI();
    },
    setupRTC: function() {
        const modeName = this.settings.rtcMode === 'D' ? "Doubles" : this.settings.rtcMode === 'T' ? "Trebles" : "Singles";
        document.getElementById("game-title").innerText = `RTC (${modeName})`;
        document.getElementById("hud-lbl-1").innerText = "HIT / 21";
        document.getElementById("hud-val-1").innerText = "0";
        document.getElementById("p2-box").style.visibility = "visible";
        document.getElementById("hud-lbl-2").innerText = "TARGET";
        document.getElementById("hud-val-2").innerText = this.settings.rtcMode === 'S' ? "1" : this.settings.rtcMode + "1";
    },
    setupCricket: function() {
        document.getElementById("game-title").innerText = "Cricket (PvP)";
        document.getElementById("main-hud").style.display = "none";
        document.getElementById("cricket-board").style.display = "block";
        this.renderCricketBoard();
    },
    renderCricketBoard: function() {
        const t = document.getElementById("cricket-board");
        const s1 = this.state.cricket.s1;
        const s2 = this.state.cricket.s2;
        t.innerHTML = `<div class="crick-row crick-header"><div class="crick-mk">${Stats.data.userName} (${s1})</div><div class="crick-num">#</div><div class="crick-mk">P2 (${s2})</div></div>`;
        [20,19,18,17,16,15,25].forEach(n => {
            const m1 = this.getMark(this.state.cricket[1][n]);
            const m2 = this.getMark(this.state.cricket[2][n]);
            t.innerHTML += `<div class="crick-row"><div class="crick-mk">${m1}</div><div class="crick-num">${n===25?'B':n}</div><div class="crick-mk">${m2}</div></div>`;
        });
    },
    getMark: function(c) { return c===0?"":c===1?"/":c===2?"X":"‚¶ª"; },
    setupPvP: function() {
        document.getElementById("game-title").innerText = "P1 vs P2";
        document.getElementById("hud-lbl-2").innerText = "P2";
        document.getElementById("p2-box").style.visibility = "visible";
        document.getElementById("match-score-display").style.visibility = "visible";
        document.getElementById("hud-val-2").innerText = this.state.startScore;
        this.updateUI();
    },
    setupBobs27: function() {
        this.state.targetList = Array.from({length: 20}, (_, i) => i + 1); this.state.targetList.push(25);
        this.state.score = 27;
        document.getElementById("game-title").innerText = "Bob's 27";
        document.getElementById("hud-lbl-1").innerText = "SCORE";
        document.getElementById("hud-val-1").innerText = "27";
        document.getElementById("p2-box").style.visibility = "visible";
        document.getElementById("hud-lbl-2").innerText = "TARGET";
        document.getElementById("hud-val-2").innerText = "D1";
    },
    setupJDC: function() {
        document.getElementById("game-title").innerText = "JDC Academy";
        document.getElementById("hud-lbl-1").innerText = "SCORE";
        document.getElementById("hud-val-1").innerText = "0";
        document.getElementById("p2-box").style.visibility = "visible";
        document.getElementById("hud-lbl-2").innerText = "TASK";
        document.getElementById("hud-val-2").innerText = "Double 10";
        document.getElementById("checkout-display").innerText = "Dart 1/3";
    },
    setupTrainer: function() {
        document.getElementById("game-title").innerText = "Checkout Trainer";
        document.getElementById("hud-lbl-1").innerText = "ATTEMPTS";
        document.getElementById("hud-val-1").innerText = "0";
        document.getElementById("p2-box").style.visibility = "visible";
        document.getElementById("hud-lbl-2").innerText = "SCORE";
        document.getElementById("btn-next").innerText = "Give Up / Next";
        this.newTrainerTarget();
    },
    newTrainerTarget: function() {
        this.state.score = Math.floor(Math.random()*60)+61; 
        this.state.startScore = this.state.score; 
        this.state.turnScore = 0; 
        this.state.dartsInTurn = 0; 
        this.markerList = []; 
        BoardRenderer.render(this.handleHit.bind(this), false, this.markerList); 
        document.getElementById("hud-val-2").innerText = this.state.score;
        this.updateUI(); 
    },
    
    handleHit: function(val, type, e) {
        if (e) {
            const svg = document.getElementById("dartboard-svg");
            const pt = svg.createSVGPoint(); pt.x = e.clientX; pt.y = e.clientY;
            const t = pt.matrixTransform(svg.getScreenCTM().inverse());
            Stats.addHeatmapPoint(t.x, t.y);
            this.markerList.push({x:t.x, y:t.y});
            if(this.markerList.length>3) this.markerList.shift();
            BoardRenderer.render(this.handleHit.bind(this), "practice"===this.mode, this.markerList);
        }
        
        SFX.playThud();
        if("league"===this.mode && this.state.dartsInTurn===0 && this.state.currentPlayer===2) return;
        this.historyStack.push(JSON.parse(JSON.stringify(this.state)));
        
        let n=val; if(type==="D") n*=2; if(type==="T") n*=3;
        if(n===180) { const ov=document.getElementById("max-overlay"); ov.style.display="flex"; setTimeout(()=>ov.style.display="none", 1500); }
        document.getElementById("status-msg").innerText=`Hit: ${type}${val}`;
        this.state.throwLog.push(n); if(this.state.throwLog.length>3) this.state.throwLog.shift();
        
        if (this.mode==="cricket") this.logicCricket(val, type);
        else if (this.mode==="rtc") this.logicRTC(val, type);
        else if (this.mode.includes("league") || this.mode==="pvp") this.logicX01(n, type);
        else if (this.mode==="bobs27") this.logicBobs(val, type);
        else if (this.mode==="jdc") this.logicJDC(val, type);
        else if (this.mode==="train_out") this.logicTrainer(n, type);
    },
    
    logicRTC: function(val, type) {
        const target = this.state.rtcTarget;
        const mode = this.settings.rtcMode;
        let hit = false;
        
        if (target === 25) { if (val === 25) hit = (mode === 'S') || (mode === 'D' && type === 'D'); } 
        else { if (val === target) { if (mode === 'S') hit = true; if (mode === 'D' && type === 'D') hit = true; if (mode === 'T' && type === 'T') hit = true; } }
        
        this.state.matchTotalDarts++; 
        if (hit) {
            Speaker.speak("Yes", 60);
            this.state.rtcHits++;
            if (this.state.rtcTarget === 20) this.state.rtcTarget = 25;
            else if (this.state.rtcTarget === 25) { alert(`Finished! Accuracy: ${Math.round(21/this.state.matchTotalDarts*100)}%`); this.goHome(); return; }
            else this.state.rtcTarget++;
            
            this.markerList = [];
            BoardRenderer.render(this.handleHit.bind(this), false, this.markerList);
            const prefix = mode === 'S' ? "" : mode;
            document.getElementById("hud-val-2").innerText = this.state.rtcTarget === 25 ? "Bull" : prefix + this.state.rtcTarget;
            document.getElementById("hud-val-1").innerText = this.state.rtcHits;
        }
    },
    
    logicTrainer: function(pts, type) {
        if(this.state.dartsInTurn>=3) return;
        this.state.dartsInTurn++;
        const left = this.state.score - pts;
        
        if(left===0 && type==="D") {
            Speaker.speak("Checkout!",100);
            this.state.trainerAttempts++;
            document.getElementById("hud-val-1").innerText = this.state.trainerAttempts;
            setTimeout(()=>this.newTrainerTarget(), 1000);
        } else if (left<=1 && left!==0) {
            Speaker.speak("Bust",0);
            this.state.score = this.state.startScore; // Reset securely
            this.state.dartsInTurn=3;
        } else {
            this.state.score = left;
            Speaker.speak(pts.toString(),0);
        }
        document.getElementById("checkout-display").innerText = Strategist.getCheckout(this.state.score);
    },

    logicCricket: function(val, type) {
        if(this.state.dartsInTurn >= 3) return;
        this.state.dartsInTurn++;
        if (val >= 15 || val === 25) {
            const p = this.state.currentPlayer; const op = p===1?2:1;
            let hits = type==='T'?3 : type==='D'?2 : 1; if(val===25) hits = type==='D'?2 : 1;
            while(hits > 0) {
                if(this.state.cricket[p][val] < 3) { this.state.cricket[p][val]++; hits--; } 
                else {
                    if(this.state.cricket[op][val] < 3) {
                        const pts = val===25?25:val;
                        if(p===1) this.state.cricket.s1 += pts; else this.state.cricket.s2 += pts;
                        Speaker.speak(String(pts), 0);
                    }
                    hits--;
                }
            }
            this.renderCricketBoard();
        }
    },
    
    // --- UPDATED X01 LOGIC FOR PRO STATS ---
    logicX01: function(pts, type, isManual) {
        if (!isManual && this.state.dartsInTurn >= 3) return;
        
        if(1 === this.state.currentPlayer) {
            this.state.matchTotalDarts++; 
            this.state.legDarts++;
            
            // TRACK FIRST 9 AVG
            if (this.state.legDarts <= 9) {
                this.state.stats.first9Score += pts;
                this.state.stats.first9Darts++;
            }
        }

        if (!isManual) this.state.dartsInTurn++;
        const cur = 1===this.state.currentPlayer?this.state.score:this.state.p2Score;
        const left = cur - pts;
        
        if (1===this.state.currentPlayer && !isManual) {
            const possible = Strategist.getCheckout(cur) !== "";
            if (possible && type === "D" && left === 0) this.state.matchHitDoubles++;
            else if (possible && left > 1 && cur%2==0 && cur<=40) this.state.matchMissedDoubles++;
        }
        
        const isDouble = (type === "D" || isManual);
        
        // WIN CONDITION
        if (left === 0 && isDouble) {
            const pIdx = 1===this.state.currentPlayer ? 0 : 1;
            this.state.matchScore[pIdx]++;
            
            if(1 === this.state.currentPlayer) {
                this.state.matchTotalScore += pts; 
                this.state.turnScore += pts; // Finish the turn count
                
                // Check stats for the final turn
                if(this.state.turnScore >= 100 && this.state.turnScore < 140) this.state.stats.tons++;
                else if(this.state.turnScore >= 140 && this.state.turnScore < 180) this.state.stats.superTons++;
                else if(this.state.turnScore === 180) this.state.stats.maxes++;

                if(isManual) { 
                    const d = prompt("Darts used in final turn?"); 
                    const dInt = parseInt(d)||1;
                    this.state.matchTotalDarts += (dInt - 1); 
                    this.state.legDarts += (dInt - 1); 
                }
                Stats.updateRecords(this.state.legDarts, pts); 
            }

            Speaker.speak("Game Shot", 100);
            this.checkMatchWin(); 
            return;
        }
        
        // BUST CONDITION
        if (left <= 1 && left !== 0) {
            Speaker.speak("Bust!", 0); 
            if(1 === this.state.currentPlayer) {
                this.state.matchTotalScore -= this.state.turnScore; // Undo points
            }
            this.state.turnScore = 0; 
            if (!isManual) this.state.dartsInTurn = 3;
        } 
        // NORMAL SCORING
        else {
            if (1===this.state.currentPlayer) {
                this.state.score = left; 
                this.state.matchTotalScore += pts; 
            } else {
                this.state.p2Score = left;
            }
            this.state.turnScore += pts; 
            Speaker.speak(pts.toString(), pts);
            
            // CHECK FOR TURN END (STATS)
            if(1 === this.state.currentPlayer && (this.state.dartsInTurn === 3 || isManual)) {
                if(this.state.turnScore >= 100 && this.state.turnScore < 140) this.state.stats.tons++;
                else if(this.state.turnScore >= 140 && this.state.turnScore < 180) this.state.stats.superTons++;
                else if(this.state.turnScore === 180) this.state.stats.maxes++;
            }
        }
        this.updateUI();
    },
    checkMatchWin: function() {
        const goal = Math.ceil(this.settings.legs / 2);
        if (this.state.matchScore[0] >= goal || this.state.matchScore[1] >= goal) {
            if (this.mode === "league" && this.state.matchScore[0] >= goal) Stats.updateLeague(this.state.botIdx);
            
            const avg = this.state.matchTotalDarts > 0 
                ? (this.state.matchTotalScore / this.state.matchTotalDarts * 3).toFixed(1) 
                : "0.0";
                
            Stats.addMatch(avg, this.state.matchScore[0] >= goal ? "W":"L", this.state.matchHitDoubles, this.state.matchMissedDoubles);
            app.showReport(this.state.matchScore[0] >= goal, avg);
        } else { alert(`Leg Over. ${this.state.matchScore[0]} - ${this.state.matchScore[1]}`); this.resetLeg(); }
    },
    resetLeg: function() {
        this.state.score = this.state.startScore; this.state.p2Score = this.state.startScore;
        this.state.dartsInTurn = 0; this.state.turnScore = 0;
        this.state.legDarts = 0; 
        this.state.cricket = { 1: {20:0,19:0,18:0,17:0,16:0,15:0,25:0}, 2: {20:0,19:0,18:0,17:0,16:0,15:0,25:0}, s1:0, s2:0 };
        this.markerList = [];
        BoardRenderer.render(this.handleHit.bind(this)); this.updateUI();
    },
    updateUI: function() {
        if(this.mode==="train_out") {
            document.getElementById("hud-val-1").innerText = this.state.trainerAttempts;
            document.getElementById("hud-val-2").innerText = this.state.startScore;
            document.getElementById("checkout-display").innerText = Strategist.getCheckout(this.state.score);
            return;
        }
        document.getElementById("hud-val-1").innerText = this.state.score;
        document.getElementById("hud-val-2").innerText = this.state.p2Score;
        document.getElementById("match-score-display").innerText = `${this.state.matchScore[0]} - ${this.state.matchScore[1]}`;
        
        const p1 = document.getElementById("p1-box");
        const p2 = document.getElementById("p2-box");
        if(p1 && p2) {
            if (this.state.currentPlayer === 1) { p1.classList.remove("inactive"); p2.classList.add("inactive"); }
            else { p2.classList.remove("inactive"); p1.classList.add("inactive"); }
        }
        
        const hint = Strategist.getCheckout(1 === this.state.currentPlayer ? this.state.score : this.state.p2Score);
        document.getElementById("checkout-display").innerText = hint;
        
        const meta1 = 1===this.state.currentPlayer ? this.state.throwLog.join(", ") : "";
        document.getElementById("p1-meta").innerText = meta1;
    },
    logicBobs: function(val, type) {
        if (this.state.dartsInTurn >= 3) return;
        this.state.dartsInTurn++;
        const target = this.state.targetList[this.state.targetIndex];
        const isBull = target === 25;
        let p = 0;
        if (isBull) { if (val === 25 && type === "D") p = 50; } else { if (val === target && type === "D") p = val * 2; }
        if (p > 0) { this.state.score += p; Speaker.speak("Yes!", 60); } else Speaker.speak("Miss", 0);
        document.getElementById("hud-val-1").innerText = this.state.score;
    },
    logicJDC: function(val, type) {
        const l = this.state.jdcLevel;
        let pts = 0;
        let target = 0, tType = 'D';
        if (l < 6) { target = 10 + l; tType = 'D'; }
        else if (l < 12) { target = 15 + (l - 6); tType = 'T'; }
        else { target = 25; tType = 'B'; }
        
        if (tType === 'B') { if (val === 25) pts = type === 'D' ? 50 : 25; }
        else { if (val === target && type === tType) pts = val * (tType === 'D' ? 2 : 3); }
        
        if (pts > 0) this.state.score += pts;
        this.state.dartsInTurn++;
        document.getElementById("checkout-display").innerText = "Dart " + (this.state.dartsInTurn + 1) + "/3";
        
        if (this.state.dartsInTurn >= 3) {
            this.state.dartsInTurn = 0; this.state.jdcLevel++;
            document.getElementById("checkout-display").innerText = "Dart 1/3";
            BoardRenderer.render(this.handleHit.bind(this)); // AUTO CLEAR
            
            if (this.state.jdcLevel > 12) { alert("JDC Finished! Score: " + this.state.score); this.goHome(); return; }
            let txt = "";
            if (this.state.jdcLevel < 6) txt = "Double " + (10 + this.state.jdcLevel);
            else if (this.state.jdcLevel < 12) txt = "Treble " + (15 + (this.state.jdcLevel - 6));
            else txt = "Bullseye";
            document.getElementById("hud-val-2").innerText = txt;
        }
        document.getElementById("hud-val-1").innerText = this.state.score;
    },
    handleAction: function() {
        if(this.mode==="train_out") { this.newTrainerTarget(); return; }
        if("cricket"===this.mode||"pvp"===this.mode){
            if(0===this.state.dartsInTurn&&"board"===this.inputMode)return;
            this.state.currentPlayer=1===this.state.currentPlayer?2:1;
            this.state.dartsInTurn=0; this.state.turnScore=0; this.state.throwLog=[]; this.markerList=[];
            Speaker.speak("Player "+this.state.currentPlayer, 0);
            this.updateUI();
            BoardRenderer.render(this.handleHit.bind(this));
        }
        else if ("league"===this.mode) {
            if(0===this.state.dartsInTurn&&"board"===this.inputMode)return;
            
            // TRACK STATS ON TURN CHANGE
            if(1 === this.state.currentPlayer) {
                if(this.state.turnScore >= 100 && this.state.turnScore < 140) this.state.stats.tons++;
                else if(this.state.turnScore >= 140 && this.state.turnScore < 180) this.state.stats.superTons++;
                else if(this.state.turnScore === 180) this.state.stats.maxes++;
            }
            
            document.getElementById("status-msg").innerText="Opponent throwing...";
            const e=BOTS[this.state.botIdx];
            setTimeout((()=>{
                const t=Math.floor(20*Math.random())-10; let o=e.avg+t;
                if(this.state.p2Score-o<=1){if(Math.random()<e.checkout){this.state.matchScore[1]++;this.checkMatchWin();return}else o=0;}
                this.state.p2Score-=o; Speaker.speak("Bot "+o,o); this.updateUI();
                this.state.dartsInTurn=0; this.state.turnScore=0; this.state.throwLog=[]; this.markerList=[];
                document.getElementById("status-msg").innerText="Your Turn";
                BoardRenderer.render(this.handleHit.bind(this));
            }),1e3);
        } else if ("bobs27"===this.mode) {
            if(0===this.state.turnScore){
                const t=this.state.targetList[this.state.targetIndex]; const pen=t===25?25:t*2;
                this.state.score-=pen; Speaker.speak("Minus "+pen,0);
            }
            if(this.state.score<0){alert("BUST!");this.goHome();return}
            this.state.targetIndex++;
            if(this.state.targetIndex>=this.state.targetList.length){alert("Finished! Score: "+this.state.score);this.goHome();return}
            const next=this.state.targetList[this.state.targetIndex];
            document.getElementById("hud-val-1").innerText=this.state.score;
            document.getElementById("hud-val-2").innerText=next===25?"Bull":"D"+next;
            this.state.dartsInTurn=0; this.state.turnScore=0; this.markerList=[];
            BoardRenderer.render(this.handleHit.bind(this));
        }
    },
    undo: function() {
        if(this.historyStack.length>0) {
            this.state = this.historyStack.pop();
            this.markerList.pop();
            this.updateUI();
            BoardRenderer.render(this.handleHit.bind(this), false, this.markerList);
            if(this.mode==="cricket") this.renderCricketBoard();
        }
    }
};

Voice.init(); Stats.load();
</script>
</body>
</html>
