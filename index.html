<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DartsOS v11: Cricket & SFX</title>
    <style>
        :root {
            --bg: #121212; --panel: #1e1e1e; --primary: #00e676; --secondary: #2979ff; --danger: #ff1744;
            --text-main: #ffffff; --text-dim: #b0bec5; --highlight: #ffd700;
        }
        body { background: var(--bg); color: var(--text-main); font-family: system-ui, -apple-system, sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }
        .screen { display: none; flex-direction: column; height: 100%; width: 100%; }
        .screen.active { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        header { padding: 15px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .icon-btn { background: #333; color: #aaa; border: 1px solid #444; border-radius: 8px; padding: 8px 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; transition: all 0.2s; }
        .icon-btn.active { background: var(--primary); color: black; border-color: var(--primary); }
        .icon-btn.listening { background: var(--danger); color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .main-area { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 10px; overflow-y: auto; }
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; max-width: 600px; margin-bottom: 20px; }
        .menu-card { background: var(--panel); border: 1px solid #333; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; position: relative; overflow: hidden; }
        .menu-card:active { transform: scale(0.98); border-color: var(--primary); }
        .chart-container { width: 100%; max-width: 600px; height: 150px; background: #222; border-radius: 12px; margin-top: 10px; position: relative; border: 1px solid #333; }
        .hud-panel { width: 100%; max-width: 600px; background: var(--panel); border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .hud-score-box { text-align: center; flex: 1; transition: opacity 0.3s; cursor: pointer; }
        .hud-score-box.inactive { opacity: 0.4; }
        .hud-score { font-size: 2.5rem; font-weight: bold; color: var(--primary); }
        .hud-label { font-size: 0.8rem; color: var(--text-dim); text-transform: uppercase; font-weight: bold; }
        .bot-score { color: var(--danger); }
        .leg-score { background: #333; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 1.2rem; margin: 0 10px; }
        .checkout-hint { background: #333; color: var(--highlight); padding: 5px 10px; border-radius: 4px; font-size: 0.9rem; font-weight: bold; margin-top: 5px; display: inline-block; min-height: 20px; border: 1px solid #444; }
        #board-container { width: 100%; max-width: 450px; aspect-ratio: 1/1; position: relative; margin: 10px 0; flex-shrink: 0; display: block; }
        svg { width: 100%; height: 100%; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); }
        #numpad-container { width: 100%; max-width: 450px; height: 400px; display: none; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 10px 0; }
        .pad-btn { background: #333; color: white; border: none; border-radius: 8px; font-size: 1.5rem; font-weight: bold; cursor: pointer; }
        .pad-btn:active { background: var(--primary); color: black; }
        .pad-enter { background: var(--primary); color: black; grid-column: span 3; }
        .controls { display: flex; gap: 10px; width: 100%; max-width: 450px; padding-bottom: 20px; margin-top: auto; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; background: #333; color: white; }
        .btn-primary { background: var(--primary); color: black; }
        .btn-miss { background: #424242; color: #ff5252; border: 1px solid #ff5252; flex: 0.4; }
        .rank-badge { background: var(--highlight); color: black; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; position: absolute; top: 10px; right: 10px; }
        
        /* CRICKET UI */
        #cricket-board { display: none; width: 100%; max-width: 450px; margin-bottom: 10px; background: #222; border-radius: 8px; overflow: hidden; }
        .crick-row { display: flex; border-bottom: 1px solid #333; height: 35px; align-items: center; }
        .crick-num { flex: 1; text-align: center; font-weight: bold; color: #aaa; background: #2a2a2a; height: 100%; display: flex; align-items: center; justify-content: center; border-left: 1px solid #333; border-right: 1px solid #333; }
        .crick-mk { flex: 2; text-align: center; color: white; font-weight: bold; font-family: monospace; font-size: 1.2rem; }
        .crick-mk.closed { color: #555; }
        .crick-header { background: #333; color: var(--highlight); font-size: 0.8rem; height: 25px; }
    </style>
</head>
<body>

<div id="screen-menu" class="screen active">
    <header>
        <h1>üéØ DartsOS <span style="font-size:0.6em; background:var(--primary); color:#000; padding:2px 6px; border-radius:4px;">v11</span></h1>
        <div style="display:flex; gap:10px;">
            <div id="settings-btn" class="icon-btn" onclick="Stats.exportData()">üíæ</div>
        </div>
    </header>
    <div class="main-area">
        <div style="width:100%; max-width:600px; display:flex; justify-content:space-between; align-items:end; margin-top:10px;">
            <span style="font-size:0.9rem; color:#aaa;">Your Form (Last 10 Matches)</span>
            <span id="current-avg-display" style="font-weight:bold; color:var(--primary)">Avg: --</span>
        </div>
        <div class="chart-container" id="chart-area"></div>
        <h2 style="margin-top: 20px;">Game Modes</h2>
        <div class="menu-grid">
            <div class="menu-card" onclick="app.loadMode('league')">
                <span class="rank-badge" id="league-rank">ROOKIE</span><span style="font-size:2rem">üèÜ</span><br><b>Bot League</b><br><span style="font-size:0.8rem; color:#888">X01 Match Play</span>
            </div>
            <div class="menu-card" onclick="app.loadMode('cricket')">
                <span style="font-size:2rem">ü¶ó</span><br><b>Cricket</b><br><span style="font-size:0.8rem; color:#888">Tactical Attack</span>
            </div>
            <div class="menu-card" onclick="app.loadMode('jdc')">
                <span style="font-size:2rem">ü•ã</span><br><b>JDC Academy</b><br><span style="font-size:0.8rem; color:#888">Official Routine</span>
            </div>
            <div class="menu-card" onclick="app.loadMode('bobs27')">
                <span style="font-size:2rem">‚ò†Ô∏è</span><br><b>Bob's 27</b><br><span style="font-size:0.8rem; color:#888">Doubles Practice</span>
            </div>
            <div class="menu-card" onclick="app.loadMode('practice')">
                <span style="font-size:2rem">üî•</span><br><b>Heatmap</b><br><span style="font-size:0.8rem; color:#888">Analysis</span>
            </div>
            <div class="menu-card" onclick="app.loadMode('pvp')">
                <span style="font-size:2rem">üë•</span><br><b>Vs Player</b><br><span style="font-size:0.8rem; color:#888">Pass & Play</span>
            </div>
        </div>
        <button class="btn" style="background:#222; margin-top:10px; font-size:0.8rem" onclick="Stats.clear()">Reset Career</button>
    </div>
</div>

<div id="screen-game" class="screen">
    <header>
        <h1 id="game-title">Game</h1>
        <div style="display:flex; gap:10px; align-items:center;">
            <div id="input-toggle" class="icon-btn" onclick="app.toggleInput()">üéØ</div>
            <div id="mic-toggle-game" class="icon-btn" onclick="Voice.toggle()">üéôÔ∏è</div>
            <button class="btn" style="width: auto; padding: 5px 15px; font-size: 0.8rem;" onclick="app.goHome()">Exit</button>
        </div>
    </header>
    <div class="main-area">
        <div class="hud-panel">
            <div class="hud-score-box" id="p1-box" onclick="app.renameUser()">
                <div class="hud-label" id="hud-lbl-1">YOU</div>
                <div class="hud-score" id="hud-val-1">501</div>
                <div class="checkout-hint" id="checkout-display"></div>
            </div>
            <div class="leg-score" id="match-score-display">0 - 0</div>
            <div class="hud-score-box" id="p2-box">
                <div class="hud-label" id="hud-lbl-2">BOT</div>
                <div class="hud-score bot-score" id="hud-val-2">501</div>
                <div class="hud-label" id="hud-sub-2"></div>
            </div>
        </div>

        <div id="cricket-board"></div>

        <div id="board-container"></div>
        
        <div id="numpad-container">
            <button class="pad-btn" onclick="app.numpadAdd(1)">1</button><button class="pad-btn" onclick="app.numpadAdd(2)">2</button><button class="pad-btn" onclick="app.numpadAdd(3)">3</button>
            <button class="pad-btn" onclick="app.numpadAdd(4)">4</button><button class="pad-btn" onclick="app.numpadAdd(5)">5</button><button class="pad-btn" onclick="app.numpadAdd(6)">6</button>
            <button class="pad-btn" onclick="app.numpadAdd(7)">7</button><button class="pad-btn" onclick="app.numpadAdd(8)">8</button><button class="pad-btn" onclick="app.numpadAdd(9)">9</button>
            <button class="pad-btn" style="color:#ff5252" onclick="app.numpadClear()">CLR</button><button class="pad-btn" onclick="app.numpadAdd(0)">0</button>
            <button class="pad-enter" onclick="app.numpadSubmit()">ENTER</button>
        </div>

        <div id="status-msg" style="height:20px; color:#aaa; font-style:italic;">Target: Open</div>

        <div class="controls" id="touch-controls">
            <button class="btn" onclick="app.undo()">Undo</button>
            <button class="btn btn-miss" onclick="app.handleHit(0, 'MISS', null)">Miss</button>
            <button class="btn btn-primary" id="btn-next" onclick="app.handleAction()">Next Round</button>
        </div>
    </div>
</div>

<script>
// --- CONFIGURATION ---
const BOTS = [
    { name: "Pub Rookie", avg: 35, checkout: 0.1 },
    { name: "Local Champ", avg: 45, checkout: 0.2 },
    { name: "County Player", avg: 55, checkout: 0.4 },
    { name: "Semi-Pro", avg: 70, checkout: 0.6 },
    { name: "The Iceman", avg: 95, checkout: 0.9 }
];

const SFX = {
    playThud: function() {
        try {
            const C = window.AudioContext || window.webkitAudioContext;
            if(!C) return;
            const ctx = new C();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            
            osc.frequency.setValueAtTime(150, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(40, ctx.currentTime + 0.1);
            
            gain.gain.setValueAtTime(0.5, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
            
            osc.start();
            osc.stop(ctx.currentTime + 0.1);
        } catch(e) {}
    }
};

const Speaker = {
    speak: function(e, t) {
        if(!window.speechSynthesis) return;
        window.speechSynthesis.cancel();
        if (180 === t) {
            const o = new SpeechSynthesisUtterance("ONE HUNDRED AND EIGHTY!");
            o.pitch = .8, o.volume = 1, window.speechSynthesis.speak(o);
            return;
        }
        const o = new SpeechSynthesisUtterance(e);
        t >= 100 ? o.pitch = .9 : t >= 60 ? o.pitch = 1 : o.pitch = 1.1;
        window.speechSynthesis.speak(o);
    }
};

const Strategist = {
    getCheckout: function(score) {
        if (score > 170 || score < 2) return "";
        if (score === 50) return "Bullseye";
        if (score <= 40 && score % 2 === 0) return "D" + (score / 2);
        for (let first = 60; first >= 1; first--) {
            let rem = score - first;
            if (rem >= 2 && rem <= 40 && rem % 2 === 0 && first % 3 === 0 && first <= 60) return "T" + (first/3) + " D" + (rem/2);
            if (rem >= 2 && rem <= 40 && rem % 2 === 0 && first <= 20) return first + " D" + (rem/2);
            if (score - 50 >= 2 && (score - 50) % 2 === 0 && (score - 50) <= 40) return "Bull D" + ((score-50)/2);
            if (score - 25 >= 2 && (score - 25) % 2 === 0 && (score - 25) <= 40) return "25 D" + ((score-25)/2);
        }
        return "No easy shot";
    }
};

// --- VOICE ---
const Voice = {
    recognition: null, isListening: false,
    init: function() {
        if (!("webkitSpeechRecognition" in window)) return;
        const e = window.webkitSpeechRecognition;
        this.recognition = new e; this.recognition.continuous = !0; this.recognition.lang = "en-US";
        this.recognition.onresult = e => this.processCommand(e.results[e.results.length - 1][0].transcript);
        this.recognition.onend = () => { if(this.isListening) this.recognition.start(); };
    },
    toggle: function() {
        if (!this.recognition) this.init();
        if (!this.recognition) return alert("Voice not supported on this device");
        this.isListening ? (this.recognition.stop(), this.isListening = !1) : (this.recognition.start(), this.isListening = !0);
        const e = this.isListening ? "icon-btn listening" : "icon-btn";
        document.getElementById("mic-toggle-menu").className = e, document.getElementById("mic-toggle-game").className = e;
    },
    processCommand: function(e) {
        const t = e.toLowerCase().trim();
        if (t.includes("next")) return app.handleAction();
        let o = "S";
        if(t.includes("double")) o = "D"; if(t.includes("triple")) o = "T";
        let n = 0;
        if (t.includes("bull")) n = 50; else if (t.includes("25")) n = 25;
        else { const m = t.match(/(\d+)/); if (m) n = parseInt(m[0]); }
        if (n > 0 && n <= 50) {
            if (n === 50) { n = 25; o = "D"; }
            app.handleHit(n, o);
        }
    }
};

// --- STATS ---
const Stats = {
    data: { matches: [], leagueRank: 0, drillLevel: 0, heatmap: [], userName: "YOU" },
    load: function() {
        const e = localStorage.getItem("darts_v11");
        if (e) this.data = JSON.parse(e);
        this.renderChart(); this.updateBadges();
    },
    save: function() { localStorage.setItem("darts_v11", JSON.stringify(this.data)) },
    setName: function(n) { this.data.userName = n; this.save(); },
    addMatch: function(e, t) {
        this.data.matches.push({ avg: parseFloat(e), result: t, type: "x01" });
        if (this.data.matches.length > 20) this.data.matches.shift();
        this.save();
    },
    addHeatmapPoint: function(x, y) {
        this.data.heatmap.push({x, y});
        if (this.data.heatmap.length > 2000) this.data.heatmap.shift();
        this.save();
    },
    updateLeague: function(e) { if(e === this.data.leagueRank){ this.data.leagueRank++; this.save(); } },
    exportData: function() {
        const e = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.data));
        const t = document.createElement("a");
        t.href = e; t.download = "dartsos_backup.json"; document.body.appendChild(t); t.click(); t.remove();
    },
    clear: function() { if(confirm("Reset all data?")) { localStorage.removeItem("darts_v11"); location.reload(); } },
    renderChart: function() {
        const e = document.getElementById("chart-area");
        const t = this.data.matches.filter(x => x.type === "x01");
        if (t.length < 2) return e.innerHTML = "<div style='padding:60px;text-align:center;color:#555'>Play matches to see stats</div>";
        const avgs = t.map(x => x.avg);
        const max = Math.max(...avgs) + 5; const min = Math.max(0, Math.min(...avgs) - 5);
        const w = 600, h = 150;
        let pts = "";
        avgs.forEach((val, i) => { pts += `${i/(avgs.length-1)*w},${h-(val-min)/(max-min)*h} `; });
        const last3 = avgs.slice(-3);
        const curr = (last3.reduce((a,b)=>a+b,0)/last3.length).toFixed(1);
        document.getElementById("current-avg-display").innerText = "Avg: " + curr;
        e.innerHTML = `<svg width="100%" height="100%" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none"><polyline points="${pts}" stroke="#00e676" fill="none" stroke-width="2"/></svg>`;
    },
    updateBadges: function() {
        const e = ["ROOKIE", "AMATEUR", "SEMI-PRO", "PRO", "ELITE"];
        document.getElementById("league-rank").innerText = e[Math.min(4, this.data.leagueRank)];
    }
};

// --- RENDERER ---
const BoardRenderer = {
    render: function(cb, showHeat) {
        const c = document.getElementById("board-container");
        c.innerHTML = "";
        const n = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        n.setAttribute("viewBox", "0 0 500 500"); n.id = "dartboard-svg";
        const a = [20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5], r = 250;

        function i(t, o, i, d, c) {
            const s = 360 / 20;
            a.forEach((a, l) => {
                const u = (l * s - s / 2) * Math.PI / 180 - Math.PI / 2, h = (l * s + s / 2) * Math.PI / 180 - Math.PI / 2,
                    p = `M${r+t*Math.cos(u)},${r+t*Math.sin(u)} L${r+o*Math.cos(u)},${r+o*Math.sin(u)} A${o},${o} 0 0,1 ${r+o*Math.cos(h)},${r+o*Math.sin(h)} L${r+t*Math.cos(h)},${r+t*Math.sin(h)} A${t},${t} 0 0,0 ${r+t*Math.cos(u)},${r+t*Math.sin(u)}Z`,
                    g = document.createElementNS("http://www.w3.org/2000/svg", "path");
                g.setAttribute("d", p), g.setAttribute("fill", l % 2 == 0 ? d : c), g.onclick = t => e(a, i, t), n.appendChild(g)
            })
        }
        i(162, 170, "D", "#e53935", "#43a047"), i(107, 162, "S", "#121212", "#eeeeee"), i(99, 107, "T", "#e53935", "#43a047"), i(16, 99, "S", "#121212", "#eeeeee");
        const d = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        d.setAttribute("cx", r), d.setAttribute("cy", r), d.setAttribute("r", 16), d.setAttribute("fill", "#43a047"), d.onclick = t => e(25, "S", t), n.appendChild(d);
        const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        c.setAttribute("cx", r), c.setAttribute("cy", r), c.setAttribute("r", 6), c.setAttribute("fill", "#e53935"), c.onclick = t => e(25, "D", t), n.appendChild(c), showHeat && Stats.data.heatmap.forEach(e => {
            const t = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            t.setAttribute("cx", e.x), t.setAttribute("cy", e.y), t.setAttribute("r", 2), t.setAttribute("fill", "rgba(255, 215, 0, 0.4)"), t.style.pointerEvents = "none", n.appendChild(t)
        }), a.forEach((e, t) => {
            const o = document.createElementNS("http://www.w3.org/2000/svg", "text"), a = (360 * t / 20 - 90) * Math.PI / 180;
            o.setAttribute("x", r + 205 * Math.cos(a)), o.setAttribute("y", r + 205 * Math.sin(a)), o.setAttribute("text-anchor", "middle"), o.setAttribute("dominant-baseline", "middle"), o.setAttribute("fill", "white"), o.setAttribute("font-size", "24"), o.setAttribute("font-weight", "bold"), o.textContent = e, o.style.pointerEvents = "none", n.appendChild(o)
        }), o.appendChild(n)
    }
};

// --- APP ---
const app = {
    mode: null, state: {}, inputMode: "board", numpadBuffer: "",
    goHome: function() {
        document.getElementById("screen-game").classList.remove("active");
        document.getElementById("screen-menu").classList.add("active");
        Stats.load();
    },
    renameUser: function() {
        const n = prompt("Enter your name:", Stats.data.userName);
        if(n) { Stats.setName(n); document.getElementById("hud-lbl-1").innerText = n; }
    },
    toggleInput: function() {
        this.inputMode = this.inputMode === "board" ? "numpad" : "board";
        const b = document.getElementById("board-container"), n = document.getElementById("numpad-container");
        const btn = document.getElementById("input-toggle");
        if (this.inputMode === "numpad") {
            b.style.display = "none"; n.style.display = "grid"; btn.innerText = "‚å®Ô∏è"; btn.classList.add("active");
        } else {
            b.style.display = "block"; n.style.display = "none"; btn.innerText = "üéØ"; btn.classList.remove("active");
        }
    },
    numpadAdd: function(e) { this.numpadBuffer += e; document.getElementById("status-msg").innerText = "Score: " + this.numpadBuffer; },
    numpadClear: function() { this.numpadBuffer = ""; document.getElementById("status-msg").innerText = "Score: "; },
    numpadSubmit: function() {
        const e = parseInt(this.numpadBuffer);
        if (isNaN(e) || e > 180) { alert("Invalid"); this.numpadClear(); return; }
        if (this.mode === "league" || this.mode === "pvp") { this.state.dartsInTurn = 3; this.logicX01(e, "S", true); }
        this.numpadClear();
    },
    loadMode: function(e) {
        this.mode = e;
        this.state = {
            score: 501, p2Score: 501, currentPlayer: 1, dartsInTurn: 0, turnScore: 0,
            matchScore: [0, 0], matchTotalScore: 0, matchTotalDarts: 0,
            targetList: [], targetIndex: 0, jdcLevel: 0,
            cricket: { 1: {20:0,19:0,18:0,17:0,16:0,15:0,25:0}, 2: {20:0,19:0,18:0,17:0,16:0,15:0,25:0}, s1:0, s2:0 }
        };
        document.getElementById("screen-menu").classList.remove("active");
        document.getElementById("screen-game").classList.add("active");
        
        BoardRenderer.render(this.handleHit.bind(this), "practice" === e);
        document.getElementById("p2-box").style.visibility = "hidden";
        document.getElementById("match-score-display").style.visibility = "hidden";
        document.getElementById("cricket-board").style.display = "none";
        document.getElementById("hud-lbl-1").innerText = Stats.data.userName;
        document.getElementById("checkout-display").innerText = "";

        if (e === "league") this.setupLeague();
        else if (e === "pvp") this.setupPvP();
        else if (e === "bobs27") this.setupBobs27();
        else if (e === "jdc") this.setupJDC();
        else if (e === "cricket") this.setupCricket();
        else document.getElementById("game-title").innerText = "Analysis";
    },
    setupLeague: function() {
        const i = Math.min(4, Stats.data.leagueRank);
        this.state.botIdx = i;
        document.getElementById("game-title").innerText = "Vs " + BOTS[i].name;
        document.getElementById("p2-box").style.visibility = "visible";
        document.getElementById("match-score-display").style.visibility = "visible";
        this.updateUI();
    },
    setupCricket: function() {
        document.getElementById("game-title").innerText = "Cricket (PvP)";
        document.getElementById("hud-val-1").innerText = "0";
        document.getElementById("hud-val-2").innerText = "0";
        document.getElementById("p2-box").style.visibility = "visible";
        document.getElementById("hud-lbl-2").innerText = "P2";
        document.getElementById("cricket-board").style.display = "block";
        this.renderCricketBoard();
    },
    renderCricketBoard: function() {
        const t = document.getElementById("cricket-board");
        t.innerHTML = `<div class="crick-row crick-header"><div class="crick-mk">${Stats.data.userName}</div><div class="crick-num">#</div><div class="crick-mk">P2</div></div>`;
        [20,19,18,17,16,15,25].forEach(n => {
            const m1 = this.getMark(this.state.cricket[1][n]);
            const m2 = this.getMark(this.state.cricket[2][n]);
            t.innerHTML += `<div class="crick-row"><div class="crick-mk">${m1}</div><div class="crick-num">${n===25?'B':n}</div><div class="crick-mk">${m2}</div></div>`;
        });
    },
    getMark: function(c) {
        if(c===0) return ""; if(c===1) return "/"; if(c===2) return "X"; return "‚¶ª";
    },
    setupPvP: function() {
        document.getElementById("game-title").innerText = "P1 vs P2";
        document.getElementById("hud-lbl-2").innerText = "P2";
        document.getElementById("p2-box").style.visibility = "visible";
        document.getElementById("match-score-display").style.visibility = "visible";
        document.getElementById("hud-val-2").innerText = "501";
        this.updateUI();
    },
    setupBobs27: function() {
        this.state.targetList = Array.from({length: 20}, (_, i) => i + 1); this.state.targetList.push(25);
        this.state.score = 27;
        document.getElementById("game-title").innerText = "Bob's 27";
        document.getElementById("hud-lbl-1").innerText = "SCORE";
        document.getElementById("hud-val-1").innerText = "27";
        document.getElementById("p2-box").style.visibility = "visible";
        document.getElementById("hud-lbl-2").innerText = "TARGET";
        document.getElementById("hud-val-2").innerText = "D1";
    },
    setupJDC: function() {
        document.getElementById("game-title").innerText = "JDC Academy";
        document.getElementById("hud-lbl-1").innerText = "SCORE";
        document.getElementById("hud-val-1").innerText = "0";
        document.getElementById("p2-box").style.visibility = "visible";
        document.getElementById("hud-lbl-2").innerText = "TASK";
        document.getElementById("hud-val-2").innerText = "Double 10";
        document.getElementById("checkout-display").innerText = "Dart 1/3";
    },
    handleHit: function(val, type, e) {
        if (e) {
            const svg = document.getElementById("dartboard-svg");
            const pt = svg.createSVGPoint(); pt.x = e.clientX; pt.y = e.clientY;
            const t = pt.matrixTransform(svg.getScreenCTM().inverse());
            Stats.addHeatmapPoint(t.x, t.y);
            const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            dot.setAttribute("cx", t.x); dot.setAttribute("cy", t.y); dot.setAttribute("r", 4);
            dot.setAttribute("fill", "#ffd700"); svg.appendChild(dot);
        }
        
        SFX.playThud();
        
        let pts = val;
        if (type === "D") pts *= 2; if (type === "T") pts *= 3;
        
        document.getElementById("status-msg").innerText = `Hit: ${type}${val}`;
        
        if (this.mode === "cricket") this.logicCricket(val, type);
        else if (this.mode.includes("league") || this.mode === "pvp") this.logicX01(pts, type);
        else if (this.mode === "bobs27") this.logicBobs(val, type);
        else if (this.mode === "jdc") this.logicJDC(val, type);
    },
    logicCricket: function(val, type) {
        if(this.state.dartsInTurn >= 3) return;
        this.state.dartsInTurn++;
        
        // Only 15-20 and Bull count
        if (val >= 15 || val === 25) {
            const p = this.state.currentPlayer;
            const op = p===1?2:1;
            let hits = type==='T'?3 : type==='D'?2 : 1;
            if(val===25) hits = type==='D'?2 : 1; // Bull Logic
            
            // Apply hits
            while(hits > 0) {
                if(this.state.cricket[p][val] < 3) {
                    this.state.cricket[p][val]++;
                    hits--;
                } else {
                    // Points?
                    if(this.state.cricket[op][val] < 3) {
                        const pts = val===25?25:val;
                        if(p===1) this.state.cricket.s1 += pts;
                        else this.state.cricket.s2 += pts;
                        Speaker.speak(String(pts), 0);
                    }
                    hits--;
                }
            }
            this.renderCricketBoard();
            document.getElementById("hud-val-1").innerText = this.state.cricket.s1;
            document.getElementById("hud-val-2").innerText = this.state.cricket.s2;
        }
    },
    logicX01: function(pts, type, isManual) {
        if (!isManual && this.state.dartsInTurn >= 3) return;
        if (!isManual) this.state.dartsInTurn++;
        
        const cur = this.state.currentPlayer === 1 ? this.state.score : this.state.p2Score;
        const left = cur - pts;
        
        const isDouble = (type === "D" || isManual);
        if (left === 0 && isDouble) {
            const pIdx = this.state.currentPlayer === 1 ? 0 : 1;
            this.state.matchScore[pIdx]++;
            Speaker.speak("Game Shot", 100);
            if(isManual) { const d=prompt("Darts used?"); this.state.dartsInTurn=parseInt(d)||3; }
            if (this.state.currentPlayer === 1) {
                this.state.matchTotalScore += 501; this.state.matchTotalDarts += this.state.dartsInTurn;
            }
            this.checkMatchWin(); return;
        }
        
        if (left <= 1 && left !== 0) {
            Speaker.speak("Bust!", 0); this.state.turnScore = 0; if (!isManual) this.state.dartsInTurn = 3;
        } else {
            if (this.state.currentPlayer === 1) this.state.score = left; else this.state.p2Score = left;
            this.state.turnScore += pts; Speaker.speak(pts.toString(), pts);
        }
        this.updateUI();
    },
    checkMatchWin: function() {
        if (this.state.matchScore[0] >= 3 || this.state.matchScore[1] >= 3) {
            if (this.mode === "league" && this.state.matchScore[0] >= 3) {
                const avg = this.state.matchTotalDarts > 0 ? (this.state.matchTotalScore / this.state.matchTotalDarts * 3).toFixed(1) : "0.0";
                Stats.addMatch(avg, "W"); Stats.updateLeague(this.state.botIdx);
            }
            alert(`Match Over! ${this.state.matchScore[0]} - ${this.state.matchScore[1]}`); this.goHome();
        } else { alert(`Leg Over. ${this.state.matchScore[0]} - ${this.state.matchScore[1]}`); this.resetLeg(); }
    },
    resetLeg: function() {
        this.state.score = 501; this.state.p2Score = 501; this.state.dartsInTurn = 0; this.state.turnScore = 0;
        // Cricket reset
        this.state.cricket = { 1: {20:0,19:0,18:0,17:0,16:0,15:0,25:0}, 2: {20:0,19:0,18:0,17:0,16:0,15:0,25:0}, s1:0, s2:0 };
        BoardRenderer.render(this.handleHit.bind(this)); this.updateUI();
    },
    updateUI: function() {
        document.getElementById("hud-val-1").innerText = this.state.score;
        document.getElementById("hud-val-2").innerText = this.state.p2Score;
        document.getElementById("match-score-display").innerText = `${this.state.matchScore[0]} - ${this.state.matchScore[1]}`;
        const p1 = document.getElementById("p1-box"), p2 = document.getElementById("p2-box");
        if (this.state.currentPlayer === 1) { p1.classList.remove("inactive"); p2.classList.add("inactive"); }
        else { p2.classList.remove("inactive"); p1.classList.add("inactive"); }
        const hint = Strategist.getCheckout(this.state.currentPlayer === 1 ? this.state.score : this.state.p2Score);
        document.getElementById("checkout-display").innerText = hint;
    },
    logicBobs: function(val, type) {
        if (this.state.dartsInTurn >= 3) return;
        this.state.dartsInTurn++;
        const target = this.state.targetList[this.state.targetIndex];
        const isBull = target === 25;
        let p = 0;
        if (isBull) { if (val === 25 && type === "D") p = 50; } else { if (val === target && type === "D") p = val * 2; }
        if (p > 0) { this.state.score += p; Speaker.speak("Yes!", 60); } else Speaker.speak("Miss", 0);
        document.getElementById("hud-val-1").innerText = this.state.score;
    },
    logicJDC: function(val, type) {
        const l = this.state.jdcLevel;
        let pts = 0;
        let target = 0, tType = 'D';
        if (l < 6) { target = 10 + l; tType = 'D'; }
        else if (l < 12) { target = 15 + (l - 6); tType = 'T'; }
        else { target = 25; tType = 'B'; }
        
        if (tType === 'B') { if (val === 25) pts = type === 'D' ? 50 : 25; }
        else { if (val === target && type === tType) pts = val * (tType === 'D' ? 2 : 3); }
        
        if (pts > 0) this.state.score += pts;
        this.state.dartsInTurn++;
        document.getElementById("checkout-display").innerText = "Dart " + (this.state.dartsInTurn + 1) + "/3";
        
        if (this.state.dartsInTurn >= 3) {
            this.state.dartsInTurn = 0; this.state.jdcLevel++;
            document.getElementById("checkout-display").innerText = "Dart 1/3";
            if (this.state.jdcLevel > 12) { alert("JDC Finished! Score: " + this.state.score); this.goHome(); return; }
            let txt = "";
            if (this.state.jdcLevel < 6) txt = "Double " + (10 + this.state.jdcLevel);
            else if (this.state.jdcLevel < 12) txt = "Treble " + (15 + (this.state.jdcLevel - 6));
            else txt = "Bullseye";
            document.getElementById("hud-val-2").innerText = txt;
        }
        document.getElementById("hud-val-1").innerText = this.state.score;
    },
    handleAction: function() {
        if(this.mode==="cricket" || this.mode==="pvp") {
            if(this.state.dartsInTurn===0 && this.inputMode==="board") return;
            this.state.currentPlayer = this.state.currentPlayer===1?2:1;
            this.state.dartsInTurn=0; this.state.turnScore=0;
            Speaker.speak("Player "+this.state.currentPlayer, 0);
            this.updateUI();
        }
        else if (this.mode === "league") {
            if (this.state.dartsInTurn === 0 && this.inputMode === "board") return;
            document.getElementById("status-msg").innerText = "Opponent throwing...";
            const e = BOTS[this.state.botIdx];
            setTimeout(() => {
                const t = Math.floor(20 * Math.random()) - 10;
                let o = e.avg + t;
                if(this.state.p2Score - o <= 1) {
                    if (Math.random() < e.checkout) { this.state.matchScore[1]++; this.checkMatchWin(); return; } else o = 0;
                }
                this.state.p2Score -= o;
                Speaker.speak("Bot " + o, o);
                this.updateUI();
                this.state.dartsInTurn = 0; this.state.turnScore = 0;
                document.getElementById("status-msg").innerText = "Your Turn";
            }, 1000);
        } else if (this.mode === "bobs27") {
            if (this.state.turnScore === 0) {
                const t = this.state.targetList[this.state.targetIndex];
                const pen = t === 25 ? 25 : t * 2;
                this.state.score -= pen;
                Speaker.speak("Minus " + pen, 0);
            }
            if (this.state.score < 0) { alert("BUST!"); this.goHome(); return; }
            this.state.targetIndex++;
            if (this.state.targetIndex >= this.state.targetList.length) { alert("Finished! Score: " + this.state.score); this.goHome(); return; }
            const next = this.state.targetList[this.state.targetIndex];
            document.getElementById("hud-val-1").innerText = this.state.score;
            document.getElementById("hud-val-2").innerText = next === 25 ? "Bull" : "D" + next;
            this.state.dartsInTurn = 0; this.state.turnScore = 0;
        }
    },
    undo: function() { alert("Undo disabled in Pro Mode"); }
};

Voice.init(); Stats.load();
</script>
</body>
</html>
